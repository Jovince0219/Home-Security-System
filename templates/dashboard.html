{% extends "base.html" %}

{% block title %}Dashboard - Security System{% endblock %}

{% block content %}
<div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
    <!-- Live Camera Feed with Face Recognition -->
    <div class="lg:col-span-2">
        <div class="bg-white rounded-lg shadow-lg p-6">
            <h2 class="text-2xl font-bold mb-4 flex items-center">
                <i class="fas fa-video mr-3 text-blue-600"></i>
                Live CCTV Feed
            </h2>
            <div class="relative">
                <video id="videoElement" class="w-full h-64 bg-black rounded-lg" autoplay muted></video>
                <canvas id="overlayCanvas" class="absolute top-0 left-0 w-full h-64 pointer-events-none"></canvas>
                <div class="absolute top-2 right-2 bg-red-600 text-white px-2 py-1 rounded text-sm">
                    <i class="fas fa-circle mr-1"></i>LIVE
                </div>
                <!-- Enhanced face detection overlay with better fitting boxes -->
                <div id="faceOverlay" class="absolute top-0 left-0 w-full h-full pointer-events-none"></div>
            </div>
            
            <!-- Enhanced controls with quick actions -->
            <div class="mt-4 grid grid-cols-2 md:grid-cols-4 gap-2">
                <button id="startCamera" class="bg-green-600 hover:bg-green-700 text-white px-3 py-2 rounded text-sm">
                    <i class="fas fa-play mr-1"></i>Start Camera
                </button>
                <button id="stopCamera" class="bg-red-600 hover:bg-red-700 text-white px-3 py-2 rounded text-sm">
                    <i class="fas fa-stop mr-1"></i>Stop Camera
                </button>
                <button id="takeScreenshot" class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-2 rounded text-sm">
                    <i class="fas fa-camera mr-1"></i>Screenshot
                </button>
                <button id="toggleRecording" class="bg-purple-600 hover:bg-purple-700 text-white px-3 py-2 rounded text-sm">
                    <i class="fas fa-record-vinyl mr-1"></i>Record
                </button>
            </div>
            
            <!-- Quick Actions Panel -->
            <div class="mt-4 bg-gray-50 rounded-lg p-4">
                <h4 class="font-semibold mb-3">Quick Actions</h4>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-2">
                    <button onclick="toggleMotionDetection()" class="bg-yellow-600 hover:bg-yellow-700 text-white px-3 py-2 rounded text-sm">
                        <i class="fas fa-running mr-1"></i>Motion Detection
                    </button>
                    <button onclick="toggleFaceRecognition()" class="bg-indigo-600 hover:bg-indigo-700 text-white px-3 py-2 rounded text-sm">
                        <i class="fas fa-user-check mr-1"></i>Face Recognition
                    </button>
                    <button onclick="playQuickMessage('warning')" class="bg-orange-600 hover:bg-orange-700 text-white px-3 py-2 rounded text-sm">
                        <i class="fas fa-volume-up mr-1"></i>Warning
                    </button>
                    <button onclick="playQuickMessage('stop')" class="bg-red-600 hover:bg-red-700 text-white px-3 py-2 rounded text-sm">
                        <i class="fas fa-hand-paper mr-1"></i>Stop
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- System Status -->
    <div class="space-y-6">
        <div class="bg-white rounded-lg shadow-lg p-6">
            <h3 class="text-lg font-bold mb-4 flex items-center">
                <i class="fas fa-heartbeat mr-2 text-green-600"></i>
                System Status
            </h3>
            <div class="space-y-3">
                <div class="flex justify-between items-center">
                    <span>Face Recognition</span>
                    <span id="faceRecognitionStatus" class="bg-green-100 text-green-800 px-2 py-1 rounded text-sm">Active</span>
                </div>
                <div class="flex justify-between items-center">
                    <span>Motion Detection</span>
                    <span id="motionDetectionStatus" class="bg-yellow-100 text-yellow-800 px-2 py-1 rounded text-sm">Inactive</span>
                </div>
                <div class="flex justify-between items-center">
                    <span>Recording</span>
                    <span id="recordingStatus" class="bg-red-100 text-red-800 px-2 py-1 rounded text-sm">Stopped</span>
                </div>
            </div>
        </div>
        
        <div class="bg-white rounded-lg shadow-lg p-6">
            <h3 class="text-lg font-bold mb-4 flex items-center">
                <i class="fas fa-chart-line mr-2 text-blue-600"></i>
                Today's Stats
            </h3>
            <div class="space-y-3" id="todayStats">
                <div class="flex justify-between">
                    <span>Face Detections</span>
                    <span class="font-bold">0</span>
                </div>
                <div class="flex justify-between">
                    <span>Motion Events</span>
                    <span class="font-bold">0</span>
                </div>
                <div class="flex justify-between">
                    <span>Alerts Sent</span>
                    <span class="font-bold">0</span>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Recent Unauthorized Detections (only show unauthorized faces and all motion) -->
<div class="mt-6 bg-white rounded-lg shadow-lg p-6">
    <h3 class="text-lg font-bold mb-4 flex items-center">
        <i class="fas fa-exclamation-triangle mr-2 text-red-600"></i>
        Recent Security Alerts (Unauthorized Only)
    </h3>
    <div class="overflow-x-auto">
        <table class="min-w-full table-auto">
            <thead>
                <tr class="bg-gray-50">
                    <th class="px-4 py-2 text-left">Time</th>
                    <th class="px-4 py-2 text-left">Type</th>
                    <th class="px-4 py-2 text-left">Detection</th>
                    <th class="px-4 py-2 text-left">Confidence</th>
                    <th class="px-4 py-2 text-left">Alert Level</th>
                    <th class="px-4 py-2 text-left">Action</th>
                </tr>
            </thead>
            <tbody id="detectionsTable">
                <!-- Detections will be loaded here -->
            </tbody>
        </table>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let videoStream = null;
let isRecording = false;
let faceRecognitionActive = true;
let motionDetectionActive = false;
let recognitionInterval = null;

// Camera controls
document.getElementById('startCamera').addEventListener('click', startCamera);
document.getElementById('stopCamera').addEventListener('click', stopCamera);
document.getElementById('takeScreenshot').addEventListener('click', takeScreenshot);
document.getElementById('toggleRecording').addEventListener('click', toggleRecording);

async function startCamera() {
    try {
        videoStream = await navigator.mediaDevices.getUserMedia({ video: true });
        document.getElementById('videoElement').srcObject = videoStream;
        
        if (faceRecognitionActive) {
            startFaceRecognition();
        }
    } catch (error) {
        console.error('Error accessing camera:', error);
        alert('Could not access camera. Please check permissions.');
    }
}

function stopCamera() {
    if (videoStream) {
        videoStream.getTracks().forEach(track => track.stop());
        document.getElementById('videoElement').srcObject = null;
        
        // Stop face recognition
        if (recognitionInterval) {
            clearInterval(recognitionInterval);
            recognitionInterval = null;
        }
        
        // Clear face overlays
        document.getElementById('faceOverlay').innerHTML = '';
    }
}

function startFaceRecognition() {
    if (recognitionInterval) return;
    
    recognitionInterval = setInterval(() => {
        recognizeFaces();
    }, 1000); // Check every second
}

function recognizeFaces() {
    const video = document.getElementById('videoElement');
    if (!video.srcObject) return;
    
    const canvas = document.createElement('canvas');
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    const ctx = canvas.getContext('2d');
    ctx.drawImage(video, 0, 0);
    
    // Convert to base64
    const imageData = canvas.toDataURL('image/jpeg');
    
    // Send for recognition
    const formData = new FormData();
    formData.append('image_data', imageData);
    
    fetch('/api/recognize_faces', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            displayFaceBoxes(data.faces);
        }
    })
    .catch(error => console.error('Face recognition error:', error));
}

function displayFaceBoxes(faces) {
    const overlay = document.getElementById('faceOverlay');
    const video = document.getElementById('videoElement');
    
    overlay.innerHTML = '';
    
    faces.forEach(face => {
        const box = document.createElement('div');
        box.style.position = 'absolute';
        box.style.border = face.is_authorized ? '3px solid green' : '3px solid red';
        box.style.backgroundColor = face.is_authorized ? 'rgba(0, 255, 0, 0.1)' : 'rgba(255, 0, 0, 0.1)';
        box.style.borderRadius = '8px'; // Rounded corners for better appearance
        
        // Calculate position relative to video element
        const videoRect = video.getBoundingClientRect();
        const scaleX = videoRect.width / video.videoWidth;
        const scaleY = videoRect.height / video.videoHeight;
        
        const [top, right, bottom, left] = face.location;
        box.style.left = (left * scaleX) + 'px';
        box.style.top = (top * scaleY) + 'px';
        box.style.width = ((right - left) * scaleX) + 'px';
        box.style.height = ((bottom - top) * scaleY) + 'px';
        
        // Add name label
        const label = document.createElement('div');
        label.style.position = 'absolute';
        label.style.top = '-30px';
        label.style.left = '0';
        label.style.backgroundColor = face.is_authorized ? 'green' : 'red';
        label.style.color = 'white';
        label.style.padding = '4px 8px';
        label.style.fontSize = '12px';
        label.style.borderRadius = '4px';
        label.style.fontWeight = 'bold';
        label.textContent = face.display_name || (face.is_authorized ? face.name : 'Unauthorized');
        
        if (face.face_covered) {
            label.textContent += ' (Covered)';
        }
        
        box.appendChild(label);
        overlay.appendChild(box);
    });
}

function takeScreenshot() {
    const video = document.getElementById('videoElement');
    const canvas = document.createElement('canvas');
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    const ctx = canvas.getContext('2d');
    ctx.drawImage(video, 0, 0);
    
    // Convert to blob and save
    canvas.toBlob(function(blob) {
        const formData = new FormData();
        formData.append('screenshot', blob, 'screenshot.jpg');
        
        fetch('/api/save_screenshot', {
            method: 'POST',
            body: formData
        }).then(response => response.json())
          .then(data => {
              if (data.success) {
                  alert('Screenshot saved successfully!');
                  loadRecentDetections();
              }
          });
    });
}

function toggleRecording() {
    const button = document.getElementById('toggleRecording');
    
    if (!isRecording) {
        fetch('/api/start_recording', { method: 'POST' })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    isRecording = true;
                    button.innerHTML = '<i class="fas fa-stop mr-1"></i>Stop Recording';
                    button.className = 'bg-red-600 hover:bg-red-700 text-white px-3 py-2 rounded text-sm';
                    updateRecordingStatus('Recording');
                } else {
                    alert('Failed to start recording: ' + (data.error || 'Unknown error'));
                }
            });
    } else {
        fetch('/api/stop_recording', { method: 'POST' })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    isRecording = false;
                    button.innerHTML = '<i class="fas fa-record-vinyl mr-1"></i>Record';
                    button.className = 'bg-purple-600 hover:bg-purple-700 text-white px-3 py-2 rounded text-sm';
                    updateRecordingStatus('Stopped');
                    
                    if (data.result && data.result.saved_to_database) {
                        alert(`Recording saved successfully!\nFile: ${data.result.filename}\nDuration: ${data.result.duration}s\nSize: ${(data.result.file_size / 1024 / 1024).toFixed(2)} MB`);
                    } else {
                        alert('Recording stopped but may not have been saved properly.');
                    }
                } else {
                    alert('Failed to stop recording: ' + (data.error || 'Unknown error'));
                }
            });
    }
}

function toggleMotionDetection() {
    const action = motionDetectionActive ? 'stop_motion_detection' : 'start_motion_detection';
    
    fetch('/api/dashboard_action', {
        method: 'POST',
        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
        body: `action=${action}`
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            motionDetectionActive = !motionDetectionActive;
            updateMotionDetectionStatus(motionDetectionActive ? 'Active' : 'Inactive');
        }
    });
}

function toggleFaceRecognition() {
    faceRecognitionActive = !faceRecognitionActive;
    
    if (faceRecognitionActive && videoStream) {
        startFaceRecognition();
    } else if (recognitionInterval) {
        clearInterval(recognitionInterval);
        recognitionInterval = null;
        document.getElementById('faceOverlay').innerHTML = '';
    }
    
    updateFaceRecognitionStatus(faceRecognitionActive ? 'Active' : 'Inactive');
}

function playQuickMessage(messageType) {
    fetch('/api/dashboard_action', {
        method: 'POST',
        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
        body: `action=play_message&message_type=${messageType}`
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            console.log('Message played:', data.result);
        } else {
            console.error('Failed to play message:', data.error);
        }
    })
    .catch(error => console.error('Error playing message:', error));
}

function updateRecordingStatus(status) {
    const element = document.getElementById('recordingStatus');
    element.textContent = status;
    element.className = status === 'Recording' ? 
        'bg-green-100 text-green-800 px-2 py-1 rounded text-sm' : 
        'bg-red-100 text-red-800 px-2 py-1 rounded text-sm';
}

function updateMotionDetectionStatus(status) {
    const element = document.getElementById('motionDetectionStatus');
    element.textContent = status;
    element.className = status === 'Active' ? 
        'bg-green-100 text-green-800 px-2 py-1 rounded text-sm' : 
        'bg-yellow-100 text-yellow-800 px-2 py-1 rounded text-sm';
}

function updateFaceRecognitionStatus(status) {
    const element = document.getElementById('faceRecognitionStatus');
    element.textContent = status;
    element.className = status === 'Active' ? 
        'bg-green-100 text-green-800 px-2 py-1 rounded text-sm' : 
        'bg-red-100 text-red-800 px-2 py-1 rounded text-sm';
}

function loadRecentDetections() {
    fetch('/api/dashboard_feed')
        .then(response => response.json())
        .then(data => {
            const tbody = document.getElementById('detectionsTable');
            tbody.innerHTML = '';
            
            data.detections.forEach(detection => {
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td class="px-4 py-2">${new Date(detection.timestamp).toLocaleString()}</td>
                    <td class="px-4 py-2">
                        <span class="px-2 py-1 rounded text-sm ${detection.type === 'face_detection' ? 'bg-blue-100 text-blue-800' : 'bg-green-100 text-green-800'}">
                            ${detection.type.replace('_', ' ')}
                        </span>
                    </td>
                    <td class="px-4 py-2 font-semibold ${detection.person_name === 'Unauthorized' ? 'text-red-600' : ''}">${detection.person_name || 'Unknown'}</td>
                    <td class="px-4 py-2">${detection.confidence ? (detection.confidence * 100).toFixed(1) + '%' : 'N/A'}</td>
                    <td class="px-4 py-2">
                        <span class="px-2 py-1 rounded text-sm ${getAlertLevelClass(detection.alert_level)}">
                            Level ${detection.alert_level}
                        </span>
                    </td>
                    <td class="px-4 py-2">
                        ${detection.screenshot_path ? 
                            `<a href="/${detection.screenshot_path}" target="_blank" class="text-blue-600 hover:underline">
                                <i class="fas fa-image mr-1"></i>View
                            </a>` : 'N/A'}
                    </td>
                `;
            });
        });
}

function getAlertLevelClass(level) {
    switch(level) {
        case 1: return 'bg-green-100 text-green-800';
        case 2: return 'bg-yellow-100 text-yellow-800';
        case 3: return 'bg-red-100 text-red-800';
        default: return 'bg-gray-100 text-gray-800';
    }
}

// Load detections on page load
document.addEventListener('DOMContentLoaded', function() {
    loadRecentDetections();
    
    // Auto-start camera
    startCamera();
});

// Refresh detections every 10 seconds
setInterval(loadRecentDetections, 10000);
</script>
{% endblock %}
