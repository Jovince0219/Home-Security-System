{% extends "base.html" %}

{% block title %}Twilio Alerts - Security System{% endblock %}

{% block content %}
<div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
    <div class="bg-white rounded-lg shadow-lg p-6">
        <h2 class="text-2xl font-bold mb-6 flex items-center">
            <i class="fas fa-phone-alt mr-3 text-blue-600"></i>
            Twilio Voice Call Configuration
        </h2>

        <form id="twilioSettingsForm" class="space-y-4">
            <div class="bg-blue-50 p-4 rounded-lg mb-4">
                <h3 class="font-semibold text-blue-800 mb-2">
                    <i class="fas fa-info-circle mr-2"></i>Twilio Account Setup
                </h3>
                <p class="text-sm text-blue-700">
                    You need a Twilio account with a phone number to make voice calls.
                    Get your credentials from the Twilio console.
                </p>
            </div>

            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Twilio Account SID</label>
                <input type="text" id="accountSid" name="account_sid"
                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                    placeholder="ACxxxxxxxxxxxxxxxxxxxxxxxx">
            </div>

            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Twilio Auth Token</label>
                <input type="password" id="authToken" name="auth_token"
                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                    placeholder="Your auth token">
            </div>

            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Twilio Phone Number</label>
                <input type="text" id="twilioNumber" name="twilio_number"
                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                    placeholder="+1234567890">
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Primary Contact Number</label>
                    <input type="text" id="primaryNumber" name="primary_number"
                        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                        placeholder="+1234567890">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Backup Contact Number</label>
                    <input type="text" id="backupNumber" name="backup_number"
                        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                        placeholder="+1234567890">
                </div>
            </div>

            <div class="flex items-center space-x-4">
                <label class="flex items-center">
                    <input type="checkbox" id="testMode" name="test_mode" class="mr-2">
                    <span class="text-sm">Enable Test Mode (no real calls)</span>
                </label>
            </div>

            <div class="flex space-x-4">
                <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded">
                    <i class="fas fa-save mr-2"></i>Save Settings
                </button>
                <button type="button" id="testCall"
                    class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded">
                    <i class="fas fa-phone-alt mr-2"></i>Test Call
                </button>
            </div>
        </form>
    </div>

    <div class="bg-white rounded-lg shadow-lg p-6">
        <h2 class="text-2xl font-bold mb-6 flex items-center">
            <i class="fas fa-history mr-3 text-gray-600"></i>
            Alert Events & Status
        </h2>

        <div class="space-y-4">
            <div class="grid grid-cols-2 gap-4 mb-4">
                <div class="bg-gray-50 p-4 rounded-lg">
                    <h3 class="font-semibold text-gray-700">Recording Status</h3>
                    <p id="recordingStatus" class="text-2xl font-bold text-green-600">Inactive</p>
                </div>
                <div class="bg-gray-50 p-4 rounded-lg">
                    <h3 class="font-semibold text-gray-700">Storage</h3>
                    <p id="storageStatus" class="text-sm text-gray-600">Loading...</p>
                </div>
            </div>

            <div class="flex space-x-4">
                <button id="refreshEvents" class="bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded">
                    <i class="fas fa-sync-alt mr-2"></i>Refresh Events
                </button>
                <button id="cleanupRecordings" class="bg-orange-600 hover:bg-orange-700 text-white px-4 py-2 rounded">
                    <i class="fas fa-trash-alt mr-2"></i>Cleanup Old Recordings
                </button>
            </div>

            <div id="eventsList" class="max-h-96 overflow-y-auto">
            </div>
        </div>
    </div>
</div>

<div class="mt-6 bg-white rounded-lg shadow-lg p-6">
    <h2 class="text-2xl font-bold mb-6 flex items-center">
        <i class="fas fa-project-diagram mr-3 text-purple-600"></i>
        Voice Call Escalation Logic
    </h2>

    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 text-center">
        <div class="bg-blue-50 p-4 rounded-lg border border-blue-200">
            <div class="w-8 h-8 bg-blue-500 text-white rounded-full flex items-center justify-center mx-auto mb-2">1
            </div>
            <h3 class="font-semibold text-blue-800">Attempt 1</h3>
            <p class="text-sm text-blue-700">Call Primary Number</p>
        </div>

        <div class="bg-blue-50 p-4 rounded-lg border border-blue-200">
            <div class="w-8 h-8 bg-blue-500 text-white rounded-full flex items-center justify-center mx-auto mb-2">2
            </div>
            <h3 class="font-semibold text-blue-800">Attempt 2</h3>
            <p class="text-sm text-blue-700">Wait 1 minute, retry Primary</p>
        </div>

        <div class="bg-blue-50 p-4 rounded-lg border border-blue-200">
            <div class="w-8 h-8 bg-blue-500 text-white rounded-full flex items-center justify-center mx-auto mb-2">3
            </div>
            <h3 class="font-semibold text-blue-800">Attempt 3</h3>
            <p class="text-sm text-blue-700">Wait 1 minute, final retry</p>
        </div>

        <div class="bg-red-50 p-4 rounded-lg border border-red-200">
            <div class="w-8 h-8 bg-red-500 text-white rounded-full flex items-center justify-center mx-auto mb-2">4
            </div>
            <h3 class="font-semibold text-red-800">Escalation</h3>
            <p class="text-sm text-red-700">Call Backup Number</p>
        </div>
    </div>

    <div class="mt-6 bg-gray-50 p-4 rounded-lg">
        <h3 class="font-semibold text-gray-800 mb-2">Alert Message</h3>
        <p class="text-sm text-gray-700 italic">
            "There is an unauthorized person detected. Please check the system."
        </p>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function () {
        // Initialize
        loadTwilioSettings();
        loadAlertEvents();
        loadRecordingStats();

        // Event listeners
        document.getElementById('twilioSettingsForm').addEventListener('submit', saveTwilioSettings);
        document.getElementById('testCall').addEventListener('click', testTwilioCall);
        document.getElementById('refreshEvents').addEventListener('click', loadAlertEvents);
        document.getElementById('cleanupRecordings').addEventListener('click', cleanupRecordings);

        // Auto-refresh events every 30 seconds
        setInterval(loadAlertEvents, 30000);
        setInterval(loadRecordingStats, 10000);
    });

    function loadTwilioSettings() {
        fetch('/api/twilio_settings')
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const settings = data.settings;
                    document.getElementById('accountSid').value = settings.account_sid || '';
                    document.getElementById('authToken').value = settings.auth_token || '';
                    document.getElementById('twilioNumber').value = settings.twilio_number || '';
                    document.getElementById('primaryNumber').value = settings.primary_number || '';
                    document.getElementById('backupNumber').value = settings.backup_number || '';
                    document.getElementById('testMode').checked = settings.test_mode;
                }
            });
    }

    function saveTwilioSettings(event) {
        event.preventDefault();

        const formData = new FormData(event.target);
        formData.append('test_mode', document.getElementById('testMode').checked);

        fetch('/api/twilio_settings', {
            method: 'POST',
            body: formData
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showNotification('Twilio settings saved successfully!', 'success');
                } else {
                    showNotification('Error saving settings: ' + data.message, 'error');
                }
            });
    }

    function testTwilioCall() {
        const primaryNumber = document.getElementById('primaryNumber').value;
        if (!primaryNumber) {
            alert('Please enter a primary number first');
            return;
        }

        const testNumber = prompt('Enter test phone number:', primaryNumber);
        if (!testNumber) return;

        const formData = new FormData();
        formData.append('test_number', testNumber);

        fetch('/api/test_twilio_call', {
            method: 'POST',
            body: formData
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showNotification('Test call initiated successfully!', 'success');
                } else {
                    showNotification('Test call failed: ' + (data.result?.error || 'Unknown error'), 'error');
                }
            });
    }

    function loadAlertEvents() {
        fetch('/api/alert_events')
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    displayEvents(data.events);
                }
            });
    }

    function displayEvents(events) {
        const container = document.getElementById('eventsList');

        if (!events || events.length === 0) {
            container.innerHTML = '<p class="text-gray-500 text-center py-4">No alert events found</p>';
            return;
        }

        let html = '';
        events.forEach(event => {
            const timestamp = new Date(event.timestamp).toLocaleString();
            const callStatus = event.call_status || 'pending';
            const reviewStatus = event.review_status || 'pending';

            html += `
            <div class="border border-gray-200 rounded-lg p-4 mb-4">
                <div class="flex justify-between items-start mb-2">
                    <div>
                        <h4 class="font-semibold">${event.trigger_type}</h4>
                        <p class="text-sm text-gray-600">${timestamp}</p>
                        <p class="text-xs text-gray-500">Event ID: ${event.event_id}</p>
                    </div>
                    <div class="text-right">
                        <span class="px-2 py-1 rounded text-xs ${getStatusClass(callStatus)}">Call: ${callStatus}</span>
                        <span class="px-2 py-1 rounded text-xs ${getReviewClass(reviewStatus)}">Review: ${reviewStatus}</span>
                    </div>
                </div>
                
                ${event.call_attempts && event.call_attempts.length > 0 ? `
                    <div class="mt-2">
                        <h5 class="text-sm font-semibold mb-1">Call Attempts:</h5>
                        ${event.call_attempts.map(attempt => `
                            <div class="text-xs text-gray-600 ml-2">
                                Attempt ${attempt.attempt_number}: ${attempt.phone_number} - 
                                <span class="${attempt.status === 'answered' ? 'text-green-600' : 'text-red-600'}">${attempt.status}</span>
                                at ${new Date(attempt.timestamp).toLocaleTimeString()}
                            </div>
                        `).join('')}
                    </div>
                ` : ''}
                
                <div class="mt-3 flex flex-col space-y-2">
                    <div class="flex space-x-2">
                        <button onclick="updateReviewStatus('${event.event_id}', 'false_alarm')" 
                                class="bg-yellow-500 hover:bg-yellow-600 text-white px-2 py-1 rounded text-xs">
                            False Alarm
                        </button>
                        <button onclick="updateReviewStatus('${event.event_id}', 'confirmed')" 
                                class="bg-green-500 hover:bg-green-600 text-white px-2 py-1 rounded text-xs">
                            Confirm
                        </button>
                        ${event.recording_filepath ? `
                        <button onclick="showVideoModal('${event.recording_filepath}')" 
                                class="bg-blue-500 hover:bg-blue-600 text-white px-2 py-1 rounded text-xs">
                            Play Video
                        </button>
                        ` : ''}
                    </div>
                    
                    ${event.recording_filepath ? `
                    <div id="video-${event.event_id}" class="hidden mt-2">
                        <div class="bg-gray-100 p-2 rounded-lg">
                            <p class="text-xs text-gray-600 mb-1">Recording Preview:</p>
                            <video controls width="100%" class="max-w-full rounded">
                                <source src="/${event.recording_filepath}" type="video/mp4">
                                Your browser does not support the video tag.
                            </video>
                            <div class="flex justify-between items-center mt-1">
                                <button onclick="verifyRecording('${event.recording_filepath}')" 
                                        class="text-xs text-gray-600 hover:text-blue-600">
                                    Verify Playback
                                </button>
                                <button onclick="hideVideo('${event.event_id}')" 
                                        class="text-xs text-red-600 hover:text-red-800">
                                    Hide
                                </button>
                            </div>
                        </div>
                    </div>
                    ` : ''}
                </div>
            </div>
            `;
        });

        container.innerHTML = html;
    }

    function showVideoModal(recordingPath) {
        // Create a modal for larger video viewing
        const modalHtml = `
        <div class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50">
            <div class="bg-white rounded-lg p-4 max-w-4xl w-full mx-4">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-bold">Security Recording</h3>
                    <button onclick="closeVideoModal()" class="text-gray-500 hover:text-gray-700">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <video controls width="100%" class="max-w-full rounded-lg" autoplay>
                    <source src="/${recordingPath}" type="video/mp4">
                    Your browser does not support the video tag.
                </video>
                <div class="mt-4 flex justify-between items-center">
                    <button onclick="verifyRecording('${recordingPath}')" 
                            class="bg-gray-600 hover:bg-gray-700 text-white px-3 py-1 rounded text-sm">
                        <i class="fas fa-check-circle mr-1"></i>Verify Playback
                    </button>
                    <button onclick="downloadRecording('${recordingPath}')" 
                            class="bg-green-600 hover:bg-green-700 text-white px-3 py-1 rounded text-sm">
                        <i class="fas fa-download mr-1"></i>Download
                    </button>
                </div>
            </div>
        </div>
        `;

        const modal = document.createElement('div');
        modal.id = 'videoModal';
        modal.innerHTML = modalHtml;
        document.body.appendChild(modal);
    }

    function closeVideoModal() {
        const modal = document.getElementById('videoModal');
        if (modal) {
            modal.remove();
        }
    }

    function showVideo(eventId) {
        const videoDiv = document.getElementById(`video-${eventId}`);
        if (videoDiv) {
            videoDiv.classList.remove('hidden');
        }
    }

    function hideVideo(eventId) {
        const videoDiv = document.getElementById(`video-${eventId}`);
        if (videoDiv) {
            videoDiv.classList.add('hidden');
        }
    }

    function verifyRecording(recordingPath) {
        const filename = recordingPath.split('/').pop();

        fetch(`/api/verify_recording/${filename}`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const verification = data.verification;
                    if (verification.playable) {
                        showNotification(`‚úÖ Video is playable: ${verification.duration_seconds}s, ${verification.file_size_mb}MB`, 'success');
                    } else {
                        showNotification(`‚ùå Video playback issue: ${verification.error}`, 'error');
                    }
                } else {
                    showNotification('‚ùå Verification failed: ' + data.error, 'error');
                }
            })
            .catch(error => {
                showNotification('‚ùå Network error during verification', 'error');
            });
    }

    function downloadRecording(recordingPath) {
        // Create a temporary link to trigger download
        const link = document.createElement('a');
        link.href = `/${recordingPath}`;
        link.download = recordingPath.split('/').pop();
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }

    // Close modal when clicking outside
    document.addEventListener('click', function (event) {
        const modal = document.getElementById('videoModal');
        if (modal && event.target === modal) {
            closeVideoModal();
        }
    });

    // Remove unused functions
    // function verifyRecordingPlayback(recordingPath) { ... }
    // function offerConversion(filename) { ... }
    // function convertRecording(filename) { ... }
    // function fixVideoSources() { ... }
    // function getRecordingInfo(filename) { ... }

    // Remove functions that are no longer needed because conversion is automatic
    // - convertVideoFormat
    // - offerConversion
    // - convertRecording
    // - fixVideoSources
    // - getRecordingInfo
    // - playRecording

    function loadRecordingStats() {
        fetch('/api/recording_stats')
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const stats = data.stats;
                    document.getElementById('recordingStatus').textContent =
                        stats.is_recording ? 'Active' : 'Inactive';
                    document.getElementById('recordingStatus').className =
                        stats.is_recording ? 'text-2xl font-bold text-green-600' : 'text-2xl font-bold text-gray-600';

                    document.getElementById('storageStatus').textContent =
                        `${stats.total_recordings} recordings, ${stats.total_size_gb} GB`;
                }
            });
    }

    function cleanupRecordings() {
        if (confirm('Delete recordings older than 3 days?')) {
            // Send an empty FormData for the POST request
            fetch('/api/cleanup_recordings', { method: 'POST', body: new FormData() })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showNotification(`Cleaned up ${data.deleted_count} old recordings`, 'success');
                        loadRecordingStats();
                        loadAlertEvents(); // Refresh events list
                    }
                });
        }
    }

    function updateReviewStatus(eventId, status) {
        const formData = new FormData();
        formData.append('event_id', eventId);
        formData.append('status', status);

        fetch('/api/update_review_status', {
            method: 'POST',
            body: formData
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showNotification('Review status updated', 'success');
                    loadAlertEvents();
                }
            });
    }

    function getStatusClass(status) {
        switch (status) {
            case 'answered': return 'bg-green-100 text-green-800';
            case 'failed': return 'bg-red-100 text-red-800';
            default: return 'bg-yellow-100 text-yellow-800';
        }
    }

    function getReviewClass(status) {
        switch (status) {
            case 'confirmed': return 'bg-green-100 text-green-800';
            case 'false_alarm': return 'bg-yellow-100 text-yellow-800';
            default: return 'bg-gray-100 text-gray-800';
        }
    }

    function showNotification(message, type) {
        // Simple notification implementation
        alert(`${type.toUpperCase()}: ${message}`);
    }

    document.addEventListener('DOMContentLoaded', function () {
        // Initialize
        loadTwilioSettings();
        loadAlertEvents();
        loadRecordingStats();

        // Event listeners
        document.getElementById('twilioSettingsForm').addEventListener('submit', saveTwilioSettings);
        document.getElementById('testCall').addEventListener('click', testTwilioCall);
        document.getElementById('refreshEvents').addEventListener('click', loadAlertEvents);
        document.getElementById('cleanupRecordings').addEventListener('click', cleanupRecordings);

        // Auto-refresh events every 30 seconds
        setInterval(loadAlertEvents, 30000);
        setInterval(loadRecordingStats, 10000);
    });

    function loadTwilioSettings() {
        fetch('/api/twilio_settings')
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const settings = data.settings;
                    document.getElementById('accountSid').value = settings.account_sid || '';
                    document.getElementById('authToken').value = settings.auth_token || '';
                    document.getElementById('twilioNumber').value = settings.twilio_number || '';
                    document.getElementById('primaryNumber').value = settings.primary_number || '';
                    document.getElementById('backupNumber').value = settings.backup_number || '';
                    document.getElementById('testMode').checked = settings.test_mode;
                }
            });
    }

    function saveTwilioSettings(event) {
        event.preventDefault();

        const formData = new FormData(event.target);
        formData.append('test_mode', document.getElementById('testMode').checked);

        fetch('/api/twilio_settings', {
            method: 'POST',
            body: formData
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showNotification('Twilio settings saved successfully!', 'success');
                } else {
                    showNotification('Error saving settings: ' + data.message, 'error');
                }
            });
    }

    function testTwilioCall() {
        const primaryNumber = document.getElementById('primaryNumber').value;
        if (!primaryNumber) {
            alert('Please enter a primary number first');
            return;
        }

        const testNumber = prompt('Enter test phone number:', primaryNumber);
        if (!testNumber) return;

        const formData = new FormData();
        formData.append('test_number', testNumber);

        fetch('/api/test_twilio_call', {
            method: 'POST',
            body: formData
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showNotification('Test call initiated successfully!', 'success');
                } else {
                    showNotification('Test call failed: ' + (data.result?.error || 'Unknown error'), 'error');
                }
            });
    }

    function loadAlertEvents() {
        fetch('/api/alert_events')
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    displayEvents(data.events);
                }
            });
    }

    function displayEvents(events) {
        const container = document.getElementById('eventsList');

        if (!events || events.length === 0) {
            container.innerHTML = '<p class="text-gray-500 text-center py-4">No alert events found</p>';
            return;
        }

        let html = '';
        events.forEach(event => {
            const timestamp = new Date(event.timestamp).toLocaleString();
            const callStatus = event.call_status || 'pending';
            const reviewStatus = event.review_status || 'pending';

            html += `
            <div class="border border-gray-200 rounded-lg p-4 mb-4">
                <div class="flex justify-between items-start mb-2">
                    <div>
                        <h4 class="font-semibold">${event.trigger_type}</h4>
                        <p class="text-sm text-gray-600">${timestamp}</p>
                        <p class="text-xs text-gray-500">Event ID: ${event.event_id}</p>
                    </div>
                    <div class="text-right">
                        <span class="px-2 py-1 rounded text-xs ${getStatusClass(callStatus)}">Call: ${callStatus}</span>
                        <span class="px-2 py-1 rounded text-xs ${getReviewClass(reviewStatus)}">Review: ${reviewStatus}</span>
                    </div>
                </div>
                
                ${event.call_attempts && event.call_attempts.length > 0 ? `
                    <div class="mt-2">
                        <h5 class="text-sm font-semibold mb-1">Call Attempts:</h5>
                        ${event.call_attempts.map(attempt => `
                            <div class="text-xs text-gray-600 ml-2">
                                Attempt ${attempt.attempt_number}: ${attempt.phone_number} - 
                                <span class="${attempt.status === 'answered' ? 'text-green-600' : 'text-red-600'}">${attempt.status}</span>
                                at ${new Date(attempt.timestamp).toLocaleTimeString()}
                            </div>
                        `).join('')}
                    </div>
                ` : ''}
                
                <div class="mt-3 flex flex-wrap gap-2">
                    <button onclick="handleFalseAlarm('${event.event_id}')" 
                            class="bg-yellow-500 hover:bg-yellow-600 text-white px-3 py-1 rounded text-xs">
                        <i class="fas fa-user-plus mr-1"></i>False Alarm
                    </button>
                    <button onclick="updateReviewStatus('${event.event_id}', 'confirmed')" 
                            class="bg-green-500 hover:bg-green-600 text-white px-3 py-1 rounded text-xs">
                        <i class="fas fa-check mr-1"></i>Confirm
                    </button>
                    ${event.recording_filepath ? `
                        <button onclick="showVideoModal('${event.recording_filepath}')" 
                                class="bg-blue-500 hover:bg-blue-600 text-white px-3 py-1 rounded text-xs">
                            <i class="fas fa-play mr-1"></i>Play Video
                        </button>
                    ` : ''}
                </div>
            </div>
            `;
        });

        container.innerHTML = html;
    }

    function handleFalseAlarm(eventId) {
        // Find the detection ID associated with this event
        fetch(`/api/alert_events`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const event = data.events.find(e => e.event_id === eventId);
                    if (event) {
                        // Get the most recent unauthorized detection
                        fetch('/api/unauthorized_detections')
                            .then(response => response.json())
                            .then(detectionData => {
                                if (detectionData.success && detectionData.detections.length > 0) {
                                    // Find detection that matches this event's timeframe
                                    const eventTime = new Date(event.timestamp);
                                    const matchingDetection = detectionData.detections.find(d => {
                                        const detectionTime = new Date(d.timestamp);
                                        const timeDiff = Math.abs(eventTime - detectionTime);
                                        return timeDiff < 60000; // Within 1 minute
                                    });

                                    if (matchingDetection) {
                                        showFalseAlarmConfirmation(eventId, matchingDetection.id);
                                    } else {
                                        alert('Could not find associated detection for this event');
                                    }
                                } else {
                                    alert('No detections available');
                                }
                            });
                    }
                }
            });
    }

    function showFalseAlarmConfirmation(eventId, detectionId) {
        if (confirm('Do you want to register this face as a Known Person (non-threatening)?')) {
            showFalseAlarmRegistration(eventId, detectionId);
        }
    }

    function showFalseAlarmRegistration(eventId, detectionId) {
        console.log(`üì∏ Fetching screenshots for detection ID: ${detectionId}`);

        // Fetch screenshots for this detection
        fetch(`/api/get_detection_screenshots/${detectionId}`)
            .then(response => response.json())
            .then(data => {
                console.log('üì∏ Screenshot data received:', data);

                if (data.success && data.screenshots && data.screenshots.length > 0) {
                    showScreenshotSelectionModal(eventId, detectionId, data.screenshots);
                } else {
                    alert('No screenshots available for this detection');
                }
            })
            .catch(error => {
                console.error('Error fetching screenshots:', error);
                alert('Error loading screenshots: ' + error.message);
            });
    }

    function showScreenshotSelectionModal(eventId, detectionId, screenshots) {
        const modalHtml = `
            <div id="falseAlarmModal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50">
                <div class="bg-white rounded-lg p-6 max-w-4xl w-full mx-4 max-h-[90vh] overflow-y-auto">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-xl font-bold">
                            <i class="fas fa-user-check mr-2 text-green-600"></i>
                            Register as Known Person
                        </h3>
                        <button onclick="closeFalseAlarmModal()" class="text-gray-500 hover:text-gray-700">
                            <i class="fas fa-times text-2xl"></i>
                        </button>
                    </div>
                    
                    <div class="bg-blue-50 p-4 rounded-lg mb-4">
                        <p class="text-sm text-blue-800">
                            <i class="fas fa-info-circle mr-2"></i>
                            <strong>Known Persons</strong> are recognized but won't trigger security alerts.
                            They are different from <strong>Authorized Persons</strong> who have full access.
                        </p>
                    </div>
                    
                    <p class="text-gray-700 mb-4 font-semibold">Select the image(s) to use for registration:</p>
                    
                    <div class="grid grid-cols-2 md:grid-cols-3 gap-4 mb-6" id="screenshotGrid">
                        ${screenshots.map((path, index) => `
                            <div class="relative group">
                                <label class="cursor-pointer block">
                                    <input type="checkbox" 
                                           id="img_${index}" 
                                           value="${path}" 
                                           class="screenshot-checkbox absolute top-3 left-3 w-6 h-6 cursor-pointer z-10"
                                           checked>
                                    <img src="/${path}" 
                                         alt="Detection ${index + 1}" 
                                         class="w-full h-48 object-cover rounded-lg border-4 border-gray-300 group-hover:border-blue-500 transition-all">
                                    <div class="absolute bottom-2 right-2 bg-black bg-opacity-60 text-white px-2 py-1 rounded text-xs">
                                        Image ${index + 1}
                                    </div>
                                </label>
                            </div>
                        `).join('')}
                    </div>
                    
                    <div class="mb-6">
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            <i class="fas fa-user mr-2"></i>Person Name:
                        </label>
                        <input type="text" 
                               id="knownPersonName" 
                               class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                               placeholder="Enter the person's name">
                    </div>
                    
                    <div class="flex space-x-4">
                        <button onclick="submitKnownPersonRegistration(${detectionId})" 
                                class="flex-1 bg-green-600 hover:bg-green-700 text-white font-semibold px-6 py-3 rounded-lg transition-colors">
                            <i class="fas fa-save mr-2"></i>Register as Known Person
                        </button>
                        <button onclick="closeFalseAlarmModal()" 
                                class="bg-gray-600 hover:bg-gray-700 text-white font-semibold px-6 py-3 rounded-lg transition-colors">
                            <i class="fas fa-times mr-2"></i>Cancel
                        </button>
                    </div>
                </div>
            </div>
        `;

        document.body.insertAdjacentHTML('beforeend', modalHtml);
    }

    function submitKnownPersonRegistration(detectionId) {
        const name = document.getElementById('knownPersonName').value.trim();
        if (!name) {
            alert('Please enter a name');
            return;

        }

        const selectedImages = Array.from(document.querySelectorAll('.screenshot-checkbox:checked'))
            .map(cb => cb.value);

        if (selectedImages.length === 0) {
            alert('Please select at least one image');
            return;
        }

        console.log(`üìù Submitting Known Person registration:`, {
            name: name,
            detection_id: detectionId,
            images: selectedImages
        });

        const formData = new FormData();
        formData.append('name', name);
        formData.append('detection_id', detectionId);
        selectedImages.forEach(img => formData.append('selected_images[]', img));

        // Show loading state
        const submitButton = event.target;
        const originalHTML = submitButton.innerHTML;
        submitButton.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Registering...';
        submitButton.disabled = true;

        fetch('/api/register_known_person', {
            method: 'POST',
            body: formData
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert(`‚úÖ ${data.message}\n\nThis person will now be recognized as a Known Person and won't trigger security alerts.`);
                    closeFalseAlarmModal();
                    loadAlertEvents(); // Refresh the alerts list
                } else {
                    alert('‚ùå Error: ' + data.error);
                    submitButton.innerHTML = originalHTML;
                    submitButton.disabled = false;
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('‚ùå An error occurred while registering the person');
                submitButton.innerHTML = originalHTML;
                submitButton.disabled = false;
            });
    }

    function closeFalseAlarmModal() {
        const modal = document.getElementById('falseAlarmModal');
        if (modal) {
            modal.remove();
        }
    }

    function showVideoModal(recordingPath) {
        const modalHtml = `
        <div id="videoModal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50">
            <div class="bg-white rounded-lg p-4 max-w-4xl w-full mx-4">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-bold">Security Recording</h3>
                    <button onclick="closeVideoModal()" class="text-gray-500 hover:text-gray-700">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <video controls width="100%" class="max-w-full rounded-lg" autoplay>
                    <source src="/${recordingPath}" type="video/mp4">
                    Your browser does not support the video tag.
                </video>
                <div class="mt-4 flex justify-between items-center">
                    <button onclick="verifyRecording('${recordingPath}')" 
                            class="bg-gray-600 hover:bg-gray-700 text-white px-3 py-1 rounded text-sm">
                        <i class="fas fa-check-circle mr-1"></i>Verify Playback
                    </button>
                    <button onclick="downloadRecording('${recordingPath}')" 
                            class="bg-green-600 hover:bg-green-700 text-white px-3 py-1 rounded text-sm">
                        <i class="fas fa-download mr-1"></i>Download
                    </button>
                </div>
            </div>
        </div>
        `;

        const modal = document.createElement('div');
        modal.id = 'videoModal';
        modal.innerHTML = modalHtml;
        document.body.appendChild(modal);
    }

    function closeVideoModal() {
        const modal = document.getElementById('videoModal');
        if (modal) {
            modal.remove();
        }
    }

    function verifyRecording(recordingPath) {
        const filename = recordingPath.split('/').pop();

        fetch(`/api/verify_recording/${filename}`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const verification = data.verification;
                    if (verification.playable) {
                        showNotification(`‚úÖ Video is playable: ${verification.duration_seconds}s, ${verification.file_size_mb}MB`, 'success');
                    } else {
                        showNotification(`‚ùå Video playback issue: ${verification.error}`, 'error');
                    }
                } else {
                    showNotification('‚ùå Verification failed: ' + data.error, 'error');
                }
            })
            .catch(error => {
                showNotification('‚ùå Network error during verification', 'error');
            });
    }

    function downloadRecording(recordingPath) {
        const link = document.createElement('a');
        link.href = `/${recordingPath}`;
        link.download = recordingPath.split('/').pop();
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }

    // Close modal when clicking outside
    document.addEventListener('click', function (event) {
        const videoModal = document.getElementById('videoModal');
        if (videoModal && event.target === videoModal) {
            closeVideoModal();
        }

        const falseAlarmModal = document.getElementById('falseAlarmModal');
        if (falseAlarmModal && event.target === falseAlarmModal) {
            closeFalseAlarmModal();
        }
    });

    function loadRecordingStats() {
        fetch('/api/recording_stats')
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const stats = data.stats;
                    document.getElementById('recordingStatus').textContent =
                        stats.is_recording ? 'Active' : 'Inactive';
                    document.getElementById('recordingStatus').className =
                        stats.is_recording ? 'text-2xl font-bold text-green-600' : 'text-2xl font-bold text-gray-600';

                    document.getElementById('storageStatus').textContent =
                        `${stats.total_recordings} recordings, ${stats.total_size_gb} GB`;
                }
            });
    }

    function cleanupRecordings() {
        if (confirm('Delete recordings older than 3 days?')) {
            fetch('/api/cleanup_recordings', { method: 'POST', body: new FormData() })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showNotification(`Cleaned up ${data.deleted_count} old recordings`, 'success');
                        loadRecordingStats();
                        loadAlertEvents();
                    }
                });
        }
    }

    function updateReviewStatus(eventId, status) {
        const formData = new FormData();
        formData.append('event_id', eventId);
        formData.append('status', status);

        fetch('/api/update_review_status', {
            method: 'POST',
            body: formData
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showNotification('Review status updated', 'success');
                    loadAlertEvents();
                }
            });
    }

    function getStatusClass(status) {
        switch (status) {
            case 'answered': return 'bg-green-100 text-green-800';
            case 'failed': return 'bg-red-100 text-red-800';
            default: return 'bg-yellow-100 text-yellow-800';
        }
    }

    function getReviewClass(status) {
        switch (status) {
            case 'confirmed': return 'bg-green-100 text-green-800';
            case 'false_alarm': return 'bg-yellow-100 text-yellow-800';
            default: return 'bg-gray-100 text-gray-800';
        }
    }

    function showNotification(message, type) {
        // Create a better notification system
        const notification = document.createElement('div');
        notification.className = `fixed top-4 right-4 z-50 px-6 py-3 rounded-lg shadow-lg ${type === 'success' ? 'bg-green-600' : 'bg-red-600'
            } text-white`;
        notification.innerHTML = `
            <div class="flex items-center space-x-2">
                <i class="fas ${type === 'success' ? 'fa-check-circle' : 'fa-exclamation-circle'}"></i>
                <span>${message}</span>
            </div>
        `;
        document.body.appendChild(notification);

        setTimeout(() => {
            notification.remove();
        }, 3000);
    }
</script>

</script>
{% endblock %}