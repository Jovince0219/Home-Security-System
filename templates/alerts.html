{% extends "base.html" %}

{% block title %}Alerts & Notifications - Security System{% endblock %}

{% block content %}
<div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
    <!-- Alert Configuration -->
    <div class="bg-white rounded-lg shadow-lg p-6">
        <h2 class="text-2xl font-bold mb-6 flex items-center">
            <i class="fas fa-cog mr-3 text-blue-600"></i>
            Alert Configuration
        </h2>
        
        <form id="alertSettingsForm" class="space-y-4">
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Owner Email</label>
                <input type="email" id="ownerEmail" name="owner_email" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="owner@example.com">
            </div>
            
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Police/Emergency Email</label>
                <input type="email" id="policeEmail" name="police_email" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="police@example.com">
            </div>
            
            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">SMTP Server</label>
                    <input type="text" id="smtpServer" name="smtp_server" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="smtp.gmail.com">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">SMTP Port</label>
                    <input type="number" id="smtpPort" name="smtp_port" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="587">
                </div>
            </div>
            
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Email Username</label>
                <input type="email" id="emailUser" name="email_user" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="your-email@gmail.com">
            </div>
            
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Email Password/App Password</label>
                <input type="password" id="emailPassword" name="email_password" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="your-app-password">
            </div>
            
            <div class="flex items-center space-x-4">
                <label class="flex items-center">
                    <input type="checkbox" id="enableEmail" name="enable_email" class="mr-2">
                    <span class="text-sm">Enable Email Notifications</span>
                </label>
                
                <label class="flex items-center">
                    <input type="checkbox" id="enablePoliceAlerts" name="enable_police_alerts" class="mr-2">
                    <span class="text-sm">Enable Police Alerts</span>
                </label>
            </div>
            
            <div class="flex space-x-4">
                <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded">
                    <i class="fas fa-save mr-2"></i>Save Settings
                </button>
                <button type="button" id="testEmail" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded">
                    <i class="fas fa-envelope mr-2"></i>Test Email
                </button>
            </div>
        </form>
    </div>
    
    <!-- Manual Alert Testing -->
    <div class="bg-white rounded-lg shadow-lg p-6">
        <h2 class="text-2xl font-bold mb-6 flex items-center">
            <i class="fas fa-bell mr-3 text-red-600"></i>
            Manual Alert Testing
        </h2>
        
        <div class="space-y-4">
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Alert Level</label>
                <select id="alertLevel" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <option value="1">Level 1 - Owner Notification Only</option>
                    <option value="2">Level 2 - Owner + Police Notification</option>
                    <option value="3">Level 3 - Full Emergency Protocol</option>
                </select>
            </div>
            
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Detection Type</label>
                <select id="detectionType" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <option value="face_detection">Face Detection</option>
                    <option value="motion_detection">Motion Detection</option>
                    <option value="manual_trigger">Manual Trigger</option>
                    <option value="system_test">System Test</option>
                </select>
            </div>
            
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Custom Message</label>
                <textarea id="customMessage" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" rows="3" placeholder="Enter custom alert message (optional)"></textarea>
            </div>
            
            <div class="flex space-x-4">
                <button id="sendAlert" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded">
                    <i class="fas fa-exclamation-triangle mr-2"></i>Send Alert
                </button>
                <button id="triggerEmergency" class="bg-red-800 hover:bg-red-900 text-white px-4 py-2 rounded">
                    <i class="fas fa-fire mr-2"></i>Emergency Protocol
                </button>
            </div>
        </div>
        
        <div id="alertResult" class="mt-4 p-3 rounded-lg hidden">
            <!-- Alert results will be displayed here -->
        </div>
    </div>
</div>

<!-- Alert History -->
<div class="mt-6 bg-white rounded-lg shadow-lg p-6">
    <h2 class="text-2xl font-bold mb-6 flex items-center">
        <i class="fas fa-history mr-3 text-gray-600"></i>
        Alert History
    </h2>
    
    <div class="mb-4">
        <button id="refreshHistory" class="bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded">
            <i class="fas fa-sync-alt mr-2"></i>Refresh History
        </button>
    </div>
    
    <div class="overflow-x-auto">
        <table class="min-w-full table-auto">
            <thead>
                <tr class="bg-gray-50">
                    <th class="px-4 py-2 text-left">Timestamp</th>
                    <th class="px-4 py-2 text-left">Alert Type</th>
                    <th class="px-4 py-2 text-left">Message</th>
                    <th class="px-4 py-2 text-left">Recipient</th>
                </tr>
            </thead>
            <tbody id="alertHistoryTable">
                <!-- Alert history will be loaded here -->
            </tbody>
        </table>
    </div>
</div>

<!-- Alert Level Information -->
<div class="mt-6 bg-white rounded-lg shadow-lg p-6">
    <h2 class="text-2xl font-bold mb-6 flex items-center">
        <i class="fas fa-info-circle mr-3 text-blue-600"></i>
        Alert Level Information
    </h2>
    
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
        <div class="bg-green-50 p-4 rounded-lg border border-green-200">
            <h3 class="text-lg font-semibold text-green-800 mb-2">
                <i class="fas fa-info-circle mr-2"></i>Level 1 - Information
            </h3>
            <ul class="text-sm text-green-700 space-y-1">
                <li>• Owner email notification</li>
                <li>• Authorized person detected</li>
                <li>• Normal system events</li>
                <li>• Low priority alerts</li>
            </ul>
        </div>
        
        <div class="bg-yellow-50 p-4 rounded-lg border border-yellow-200">
            <h3 class="text-lg font-semibold text-yellow-800 mb-2">
                <i class="fas fa-exclamation-triangle mr-2"></i>Level 2 - Warning
            </h3>
            <ul class="text-sm text-yellow-700 space-y-1">
                <li>• Owner email notification</li>
                <li>• Police/Emergency notification</li>
                <li>• Unauthorized person detected</li>
                <li>• Suspicious activity</li>
            </ul>
        </div>
        
        <div class="bg-red-50 p-4 rounded-lg border border-red-200">
            <h3 class="text-lg font-semibold text-red-800 mb-2">
                <i class="fas fa-fire mr-2"></i>Level 3 - Emergency
            </h3>
            <ul class="text-sm text-red-700 space-y-1">
                <li>• All Level 2 actions</li>
                <li>• Emergency protocol activation</li>
                <li>• System lockdown</li>
                <li>• Immediate response required</li>
            </ul>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Initialize event listeners
    document.getElementById('alertSettingsForm').addEventListener('submit', saveAlertSettings);
    document.getElementById('testEmail').addEventListener('click', testEmailConfig);
    document.getElementById('sendAlert').addEventListener('click', sendManualAlert);
    document.getElementById('triggerEmergency').addEventListener('click', triggerEmergencyProtocol);
    document.getElementById('refreshHistory').addEventListener('click', loadAlertHistory);
    
    // Load initial data
    loadAlertSettings();
    loadAlertHistory();
});

function saveAlertSettings(event) {
    event.preventDefault();
    
    const formData = new FormData(event.target);
    formData.append('enable_email', document.getElementById('enableEmail').checked);
    formData.append('enable_police_alerts', document.getElementById('enablePoliceAlerts').checked);
    
    fetch('/api/update_alert_settings', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showResult('Settings saved successfully!', 'success');
        } else {
            showResult('Error: ' + data.error, 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showResult('An error occurred while saving settings', 'error');
    });
}

function testEmailConfig() {
    const ownerEmail = document.getElementById('ownerEmail').value;
    if (!ownerEmail) {
        alert('Please enter an owner email address first');
        return;
    }
    
    const formData = new FormData();
    formData.append('recipient', ownerEmail);
    
    fetch('/api/test_email', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showResult('Test email result: ' + data.result, data.result.includes('successfully') ? 'success' : 'warning');
        } else {
            showResult('Error: ' + data.error, 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showResult('An error occurred while testing email', 'error');
    });
}

function sendManualAlert() {
    const alertLevel = document.getElementById('alertLevel').value;
    const detectionType = document.getElementById('detectionType').value;
    const customMessage = document.getElementById('customMessage').value;
    
    const formData = new FormData();
    formData.append('alert_level', alertLevel);
    formData.append('detection_type', detectionType);
    if (customMessage) {
        formData.append('message', customMessage);
    }
    
    fetch('/api/send_alert', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            displayAlertResult(data.result);
            loadAlertHistory(); // Refresh history
        } else {
            showResult('Error: ' + data.error, 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showResult('An error occurred while sending alert', 'error');
    });
}

function triggerEmergencyProtocol() {
    if (confirm('This will trigger the full emergency protocol. Are you sure?')) {
        const reason = prompt('Enter reason for emergency protocol:') || 'Manual emergency trigger';
        
        const formData = new FormData();
        formData.append('reason', reason);
        
        fetch('/api/trigger_emergency', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showResult('Emergency protocol result: ' + data.result, 'warning');
                loadAlertHistory(); // Refresh history
            } else {
                showResult('Error: ' + data.error, 'error');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showResult('An error occurred while triggering emergency protocol', 'error');
        });
    }
}

function displayAlertResult(result) {
    const resultDiv = document.getElementById('alertResult');
    resultDiv.className = 'mt-4 p-3 rounded-lg bg-blue-50 border border-blue-200';
    
    let html = `<h4 class="font-semibold text-blue-800 mb-2">Alert Level ${result.level} Triggered</h4>`;
    html += '<ul class="text-sm text-blue-700 space-y-1">';
    
    result.actions.forEach(action => {
        html += `<li>• ${action}</li>`;
    });
    
    html += '</ul>';
    resultDiv.innerHTML = html;
    resultDiv.classList.remove('hidden');
}

function loadAlertSettings() {
    fetch('/api/get_alert_settings')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const settings = data.settings;
                document.getElementById('ownerEmail').value = settings.owner_email || '';
                document.getElementById('policeEmail').value = settings.police_email || '';
                document.getElementById('smtpServer').value = settings.smtp_server || '';
                document.getElementById('smtpPort').value = settings.smtp_port || '';
                document.getElementById('emailUser').value = settings.email_user || '';
                document.getElementById('enableEmail').checked = settings.enable_email;
                document.getElementById('enablePoliceAlerts').checked = settings.enable_police_alerts;
            }
        })
        .catch(error => {
            console.error('Error loading settings:', error);
        });
}

function loadAlertHistory() {
    fetch('/api/get_alert_history')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const tbody = document.getElementById('alertHistoryTable');
                tbody.innerHTML = '';
                
                if (data.alerts.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="4" class="px-4 py-2 text-center text-gray-500">No alerts found</td></tr>';
                    return;
                }
                
                data.alerts.forEach(alert => {
                    const row = tbody.insertRow();
                    row.innerHTML = `
                        <td class="px-4 py-2">${new Date(alert.sent_at).toLocaleString()}</td>
                        <td class="px-4 py-2">
                            <span class="px-2 py-1 rounded text-sm ${getAlertTypeClass(alert.alert_type)}">
                                ${alert.alert_type}
                            </span>
                        </td>
                        <td class="px-4 py-2">${alert.message}</td>
                        <td class="px-4 py-2">${alert.recipient || 'N/A'}</td>
                    `;
                });
            }
        })
        .catch(error => {
            console.error('Error loading alert history:', error);
        });
}

function getAlertTypeClass(alertType) {
    if (alertType.includes('Level 1')) return 'bg-green-100 text-green-800';
    if (alertType.includes('Level 2')) return 'bg-yellow-100 text-yellow-800';
    if (alertType.includes('Level 3') || alertType.includes('Emergency')) return 'bg-red-100 text-red-800';
    return 'bg-gray-100 text-gray-800';
}

function showResult(message, type) {
    const resultDiv = document.getElementById('alertResult');
    let bgClass = 'bg-blue-50 border-blue-200';
    let textClass = 'text-blue-800';
    
    if (type === 'success') {
        bgClass = 'bg-green-50 border-green-200';
        textClass = 'text-green-800';
    } else if (type === 'error') {
        bgClass = 'bg-red-50 border-red-200';
        textClass = 'text-red-800';
    } else if (type === 'warning') {
        bgClass = 'bg-yellow-50 border-yellow-200';
        textClass = 'text-yellow-800';
    }
    
    resultDiv.className = `mt-4 p-3 rounded-lg border ${bgClass}`;
    resultDiv.innerHTML = `<p class="${textClass}">${message}</p>`;
    resultDiv.classList.remove('hidden');
}
</script>
{% endblock %}
