{% extends "base.html" %}

{% block title %}Twilio Alerts - Security System{% endblock %}

{% block content %}
<div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
    <div class="bg-white rounded-lg shadow-lg p-6">
        <h2 class="text-2xl font-bold mb-6 flex items-center">
            <i class="fas fa-phone-alt mr-3 text-blue-600"></i>
            Twilio Voice Call Configuration
        </h2>

        <form id="twilioSettingsForm" class="space-y-4">
            <div class="bg-blue-50 p-4 rounded-lg mb-4">
                <h3 class="font-semibold text-blue-800 mb-2">
                    <i class="fas fa-info-circle mr-2"></i>Twilio Account Setup
                </h3>
                <p class="text-sm text-blue-700">
                    You need a Twilio account with a phone number to make voice calls.
                    Get your credentials from the Twilio console.
                </p>
            </div>

            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Twilio Account SID</label>
                <input type="text" id="accountSid" name="account_sid"
                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                    placeholder="ACxxxxxxxxxxxxxxxxxxxxxxxx">
            </div>

            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Twilio Auth Token</label>
                <input type="password" id="authToken" name="auth_token"
                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                    placeholder="Your auth token">
            </div>

            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Twilio Phone Number</label>
                <input type="text" id="twilioNumber" name="twilio_number"
                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                    placeholder="+1234567890">
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Primary Contact Number</label>
                    <input type="text" id="primaryNumber" name="primary_number"
                        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                        placeholder="+1234567890">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Backup Contact Number</label>
                    <input type="text" id="backupNumber" name="backup_number"
                        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                        placeholder="+1234567890">
                </div>
            </div>

            <div class="flex items-center space-x-4">
                <label class="flex items-center">
                    <input type="checkbox" id="testMode" name="test_mode" class="mr-2">
                    <span class="text-sm">Enable Test Mode (no real calls)</span>
                </label>
            </div>

            <div class="flex space-x-4">
                <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded">
                    <i class="fas fa-save mr-2"></i>Save Settings
                </button>
                <button type="button" id="testCall"
                    class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded">
                    <i class="fas fa-phone-alt mr-2"></i>Test Call
                </button>
            </div>
        </form>
    </div>

    <div class="bg-white rounded-lg shadow-lg p-6">
        <h2 class="text-2xl font-bold mb-6 flex items-center">
            <i class="fas fa-history mr-3 text-gray-600"></i>
            Alert Events & Status
        </h2>
        <!-- 
        <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
            <h2 class="text-2xl font-bold mb-4">Alert Filtering</h2>
            <div class="flex flex-wrap gap-2">
                <button class="filter-btn active bg-gray-200 hover:bg-gray-300 px-4 py-2 rounded transition-colors"
                    data-filter="all">
                    All Alerts
                </button>
                <button class="filter-btn bg-green-200 hover:bg-green-300 px-4 py-2 rounded transition-colors"
                    data-filter="authorized">
                    Authorized
                </button>
                <button class="filter-btn bg-red-200 hover:bg-red-300 px-4 py-2 rounded transition-colors"
                    data-filter="unauthorized">
                    Unauthorized
                </button>
                <button class="filter-btn bg-blue-200 hover:bg-blue-300 px-4 py-2 rounded transition-colors"
                    data-filter="known">
                    Known Persons
                </button>
            </div>
        </div> -->

        <div class="space-y-4">
            <div class="grid grid-cols-2 gap-4 mb-4">
                <div class="bg-gray-50 p-4 rounded-lg">
                    <h3 class="font-semibold text-gray-700">Recording Status</h3>
                    <p id="recordingStatus" class="text-2xl font-bold text-green-600">Inactive</p>
                </div>
                <div class="bg-gray-50 p-4 rounded-lg">
                    <h3 class="font-semibold text-gray-700">Storage</h3>
                    <p id="storageStatus" class="text-sm text-gray-600">Loading...</p>
                </div>
            </div>

            <div class="flex space-x-4">
                <button id="refreshEvents" class="bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded">
                    <i class="fas fa-sync-alt mr-2"></i>Refresh Events
                </button>
                <button id="cleanupRecordings" class="bg-orange-600 hover:bg-orange-700 text-white px-4 py-2 rounded">
                    <i class="fas fa-trash-alt mr-2"></i>Cleanup Old Recordings
                </button>
            </div>

            <div id="eventsList" class="max-h-96 overflow-y-auto">
            </div>
        </div>
    </div>
</div>

<div class="mt-6 bg-white rounded-lg shadow-lg p-6">
    <h2 class="text-2xl font-bold mb-6 flex items-center">
        <i class="fas fa-project-diagram mr-3 text-purple-600"></i>
        Voice Call Escalation Logic
    </h2>

    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 text-center">
        <div class="bg-blue-50 p-4 rounded-lg border border-blue-200">
            <div class="w-8 h-8 bg-blue-500 text-white rounded-full flex items-center justify-center mx-auto mb-2">1
            </div>
            <h3 class="font-semibold text-blue-800">Attempt 1</h3>
            <p class="text-sm text-blue-700">Call Primary Number</p>
        </div>

        <div class="bg-blue-50 p-4 rounded-lg border border-blue-200">
            <div class="w-8 h-8 bg-blue-500 text-white rounded-full flex items-center justify-center mx-auto mb-2">2
            </div>
            <h3 class="font-semibold text-blue-800">Attempt 2</h3>
            <p class="text-sm text-blue-700">Wait 1 minute, retry Primary</p>
        </div>

        <div class="bg-blue-50 p-4 rounded-lg border border-blue-200">
            <div class="w-8 h-8 bg-blue-500 text-white rounded-full flex items-center justify-center mx-auto mb-2">3
            </div>
            <h3 class="font-semibold text-blue-800">Attempt 3</h3>
            <p class="text-sm text-blue-700">Wait 1 minute, final retry</p>
        </div>

        <div class="bg-red-50 p-4 rounded-lg border border-red-200">
            <div class="w-8 h-8 bg-red-500 text-white rounded-full flex items-center justify-center mx-auto mb-2">4
            </div>
            <h3 class="font-semibold text-red-800">Escalation</h3>
            <p class="text-sm text-red-700">Call Backup Number</p>
        </div>
    </div>

    <div class="mt-6 bg-gray-50 p-4 rounded-lg">
        <h3 class="font-semibold text-gray-800 mb-2">Alert Message</h3>
        <p class="text-sm text-gray-700 italic">
            "There is an unauthorized person detected. Please check the system."
        </p>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.getElementById('refreshEvents').addEventListener('click', function () {
        // Get the currently active filter
        const activeFilter = document.querySelector('.filter-btn.active');
        if (activeFilter) {
            const filterType = activeFilter.getAttribute('data-filter');

            console.log(`ðŸ”„ Refreshing with filter: ${filterType}`);

            // Route to correct function based on active filter
            switch (filterType) {
                case 'all':
                    loadAlertEvents();
                    break;
                case 'authorized':
                    loadAuthorizedEvents();
                    break;
                case 'unauthorized':
                    loadAlertEvents();
                    break;
                case 'known':
                    loadKnownEvents();
                    break;
                default:
                    loadAlertEvents();
            }
        } else {
            // No filter active, default to all alerts
            loadAlertEvents();
        }
    });

    function showNotification(message, type) {
        // Create a better notification system
        const notification = document.createElement('div');
        notification.className = `fixed top-4 right-4 z-50 px-6 py-3 rounded-lg shadow-lg ${type === 'success' ? 'bg-green-600' : 'bg-red-600'} text-white`;
        notification.innerHTML = `
        <div class="flex items-center space-x-2">
            <i class="fas ${type === 'success' ? 'fa-check-circle' : 'fa-exclamation-circle'}"></i>
            <span>${message}</span>
        </div>
    `;
        document.body.appendChild(notification);

        setTimeout(() => {
            notification.remove();
        }, 3000);
    }

    function showImageModal(imagePath) {
        const modalHtml = `
    <div id="imageModal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50">
        <div class="bg-white rounded-lg p-4 max-w-4xl w-full mx-4">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-bold">Detection Image</h3>
                <button onclick="closeModal()" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <img src="/${imagePath}" alt="Detection" class="w-full h-auto rounded-lg">
            <div class="mt-4 text-center">
                <button onclick="closeModal()" class="bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded">
                    Close
                </button>
            </div>
        </div>
    </div>
    `;

        const modal = document.createElement('div');
        modal.id = 'imageModal';
        modal.innerHTML = modalHtml;
        document.body.appendChild(modal);
    }

    function closeModal() {
        const modal = document.getElementById('imageModal');
        if (modal) {
            modal.remove();
        }
    }

    function showAlertDetails(alertId) {
        alert(`Alert ID: ${alertId}\n\nDetailed information would be shown here.`);
    }

    function loadAlerts(filterType = 'all') {
        console.log(`ðŸ“Š Loading alerts with filter: ${filterType}`);

        // Show loading state
        const container = document.getElementById('alertsContainer');
        container.innerHTML = '<div class="text-center py-8"><i class="fas fa-spinner fa-spin text-2xl text-blue-600"></i><p class="mt-2 text-gray-600">Loading alerts...</p></div>';

        fetch(`/api/get_filtered_alerts?filter=${filterType}`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    displayAlertsWithVideos(data.alerts, filterType);

                    // Debug log to verify filtering
                    const categories = [...new Set(data.alerts.map(alert => alert.category))];
                    console.log(`ðŸ“Š Filter '${filterType}' returned alerts with categories:`, categories);
                } else {
                    console.error('Failed to load alerts:', data.error);
                    showNotification('Error loading alerts: ' + data.error, 'error');
                    container.innerHTML = '<div class="text-center py-8 text-red-600"><i class="fas fa-exclamation-triangle"></i><p>Error loading alerts</p></div>';
                }
            })
            .catch(error => {
                console.error('Error loading alerts:', error);
                showNotification('Network error loading alerts', 'error');
                container.innerHTML = '<div class="text-center py-8 text-red-600"><i class="fas fa-exclamation-triangle"></i><p>Network error</p></div>';
            });
    }

    function createAlertCard(alert) {
        // Determine icon and color based on category
        let icon, color, badge;

        switch (alert.category) {
            case 'authorized':
                icon = 'fa-user-check';
                color = 'success';
                badge = 'Authorized';
                break;
            case 'known':
                icon = 'fa-user-friends';
                color = 'info';
                badge = 'Known Person';
                break;
            case 'unauthorized':
                icon = 'fa-user-times';
                color = 'danger';
                badge = 'Unauthorized';
                break;
            case 'motion':
                icon = 'fa-running';
                color = 'warning';
                badge = 'Motion';
                break;
            default:
                icon = 'fa-bell';
                color = 'secondary';
                badge = 'Alert';
        }

        const timestamp = new Date(alert.timestamp).toLocaleString();
        const confidence = Math.round(alert.confidence * 100);

        return `
        <div class="card alert-card mb-3 border-${color}">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-start">
                    <div class="d-flex align-items-center">
                        <i class="fas ${icon} text-${color} fa-2x me-3"></i>
                        <div>
                            <h5 class="card-title mb-1">${alert.person_name}</h5>
                            <span class="badge bg-${color}">${badge}</span>
                            <span class="badge bg-secondary ms-1">${confidence}% confidence</span>
                        </div>
                    </div>
                    <small class="text-muted">${timestamp}</small>
                </div>
                
                ${alert.screenshot_path ? `
                <div class="mt-2">
                    <img src="${alert.screenshot_path}" class="alert-thumbnail" 
                         alt="Detection screenshot" onclick="viewImage('${alert.screenshot_path}')">
                </div>
                ` : ''}
                
                ${alert.recording_path ? `
                <div class="mt-2">
                    <button class="btn btn-sm btn-outline-primary" onclick="playRecording('${alert.recording_path}')">
                        <i class="fas fa-play"></i> Play Recording
                    </button>
                </div>
                ` : ''}
            </div>
        </div>
    `;
    }

    // Initialize when page loads
    $(document).ready(function () {
        setupAlertFilters();
        loadAlerts('all'); // Load all alerts by default
    });

    function loadTwilioSettings() {
        fetch('/api/twilio_settings')
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const settings = data.settings;
                    document.getElementById('accountSid').value = settings.account_sid || '';
                    document.getElementById('authToken').value = settings.auth_token || '';
                    document.getElementById('twilioNumber').value = settings.twilio_number || '';
                    document.getElementById('primaryNumber').value = settings.primary_number || '';
                    document.getElementById('backupNumber').value = settings.backup_number || '';
                    document.getElementById('testMode').checked = settings.test_mode;
                }
            });
    }

    function debugAllDetections() {
        fetch('/api/debug_all_detections')
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    console.log('All detections:', data.detections);
                    alert(`Found ${data.total_detections} detections. Check console for details.`);
                } else {
                    alert('Debug failed: ' + data.error);
                }
            });
    }

    function debugAllRecordings() {
        fetch('/api/debug_all_recordings')
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    console.log('All recordings:', data.recordings);
                    alert(`Found ${data.total_recordings} recordings. Check console for details.`);
                } else {
                    alert('Debug failed: ' + data.error);
                }
            });
    }

    function saveTwilioSettings(event) {
        event.preventDefault();

        const formData = new FormData(event.target);
        formData.append('test_mode', document.getElementById('testMode').checked);

        fetch('/api/twilio_settings', {
            method: 'POST',
            body: formData
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showNotification('Twilio settings saved successfully!', 'success');
                } else {
                    showNotification('Error saving settings: ' + data.message, 'error');
                }
            });
    }

    function testTwilioCall() {
        const primaryNumber = document.getElementById('primaryNumber').value;
        if (!primaryNumber) {
            alert('Please enter a primary number first');
            return;
        }

        const testNumber = prompt('Enter test phone number:', primaryNumber);
        if (!testNumber) return;

        const formData = new FormData();
        formData.append('test_number', testNumber);

        fetch('/api/test_twilio_call', {
            method: 'POST',
            body: formData
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showNotification('Test call initiated successfully!', 'success');
                } else {
                    showNotification('Test call failed: ' + (data.result?.error || 'Unknown error'), 'error');
                }
            });
    }

    function loadAlertEvents() {
        fetch('/api/alert_events')
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    console.log(`ðŸ“Š Loaded ${data.events.length} events, will deduplicate`);
                    displayEvents(data.events);
                } else {
                    document.getElementById('eventsList').innerHTML = `
                    <div class="py-6 text-center text-red-600">
                        <i class="fas fa-exclamation-triangle"></i>
                        <p>Error loading events</p>
                    </div>
                `;
                }
            })
            .catch(error => {
                console.error('Error loading alert events:', error);
                document.getElementById('eventsList').innerHTML = `
                <div class="py-6 text-center text-red-600">
                    <i class="fas fa-exclamation-triangle"></i>
                    <p>Network error loading events</p>
                </div>
            `;
            });
    }

    async function verifyAndDisplayEvent(event) {
        try {
            if (event.recording_filepath) {
                const isPlayable = await checkVideoPlayability(event.recording_filepath);
                return {
                    ...event,
                    videoPlayable: isPlayable
                };
            }
            return {
                ...event,
                videoPlayable: false
            };
        } catch (error) {
            console.warn(`Error verifying event ${event.event_id}:`, error);
            return {
                ...event,
                videoPlayable: false
            };
        }
    }



    function showVideoModal(recordingPath) {
        // Create a modal for larger video viewing
        const modalHtml = `
        <div class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50">
            <div class="bg-white rounded-lg p-4 max-w-4xl w-full mx-4">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-bold">Security Recording</h3>
                    <button onclick="closeVideoModal()" class="text-gray-500 hover:text-gray-700">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <video controls width="100%" class="max-w-full rounded-lg" autoplay>
                    <source src="/${recordingPath}" type="video/mp4">
                    Your browser does not support the video tag.
                </video>
                <div class="mt-4 flex justify-between items-center">
                    <button onclick="verifyRecording('${recordingPath}')" 
                            class="bg-gray-600 hover:bg-gray-700 text-white px-3 py-1 rounded text-sm">
                        <i class="fas fa-check-circle mr-1"></i>Verify Playback
                    </button>
                    <button onclick="downloadRecording('${recordingPath}')" 
                            class="bg-green-600 hover:bg-green-700 text-white px-3 py-1 rounded text-sm">
                        <i class="fas fa-download mr-1"></i>Download
                    </button>
                </div>
            </div>
        </div>
        `;

        const modal = document.createElement('div');
        modal.id = 'videoModal';
        modal.innerHTML = modalHtml;
        document.body.appendChild(modal);
    }

    function closeVideoModal() {
        const modal = document.getElementById('videoModal');
        if (modal) {
            modal.remove();
        }
    }

    function showVideo(eventId) {
        const videoDiv = document.getElementById(`video-${eventId}`);
        if (videoDiv) {
            videoDiv.classList.remove('hidden');
        }
    }

    function hideVideo(eventId) {
        const videoDiv = document.getElementById(`video-${eventId}`);
        if (videoDiv) {
            videoDiv.classList.add('hidden');
        }
    }

    function verifyRecording(recordingPath) {
        const filename = recordingPath.split('/').pop();

        fetch(`/api/verify_recording/${filename}`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const verification = data.verification;
                    if (verification.playable) {
                        showNotification(`âœ… Video is playable: ${verification.duration_seconds}s, ${verification.file_size_mb}MB`, 'success');
                    } else {
                        showNotification(`âŒ Video playback issue: ${verification.error}`, 'error');
                    }
                } else {
                    showNotification('âŒ Verification failed: ' + data.error, 'error');
                }
            })
            .catch(error => {
                showNotification('âŒ Network error during verification', 'error');
            });
    }

    function downloadRecording(recordingPath) {
        // Create a temporary link to trigger download
        const link = document.createElement('a');
        link.href = `/${recordingPath}`;
        link.download = recordingPath.split('/').pop();
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }

    // Close modal when clicking outside
    document.addEventListener('click', function (event) {
        const modal = document.getElementById('videoModal');
        if (modal && event.target === modal) {
            closeVideoModal();
        }
    });

    // Initialize when page loads
    document.addEventListener('DOMContentLoaded', function () {
        console.log('ðŸš€ Initializing alert filters...');

        // Initialize Twilio settings (your existing code)
        loadTwilioSettings();
        loadAlertEvents(); // Start with unauthorized (existing behavior)
        loadRecordingStats();

        // Event listeners (your existing code)
        document.getElementById('twilioSettingsForm').addEventListener('submit', saveTwilioSettings);
        document.getElementById('testCall').addEventListener('click', testTwilioCall);
        document.getElementById('refreshEvents').addEventListener('click', function () {
            // Refresh based on current filter
            const activeFilter = document.querySelector('.filter-btn.active').getAttribute('data-filter');
            switch (activeFilter) {
                case 'authorized': loadAuthorizedEvents(); break;
                case 'known': loadKnownEvents(); break;
                default: loadAlertEvents();
            }
        });
        document.getElementById('cleanupRecordings').addEventListener('click', cleanupRecordings);

        // Setup filters LAST
        setupAlertFilters();

        console.log('âœ… Alert filters initialized');
    });

    function loadRecordingStats() {
        fetch('/api/recording_stats')
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const stats = data.stats;
                    document.getElementById('recordingStatus').textContent =
                        stats.is_recording ? 'Active' : 'Inactive';
                    document.getElementById('recordingStatus').className =
                        stats.is_recording ? 'text-2xl font-bold text-green-600' : 'text-2xl font-bold text-gray-600';

                    document.getElementById('storageStatus').textContent =
                        `${stats.total_recordings} recordings, ${stats.total_size_gb} GB`;
                }
            });
    }

    function cleanupRecordings() {
        if (confirm('Delete recordings older than 3 days?')) {
            // Send an empty FormData for the POST request
            fetch('/api/cleanup_recordings', { method: 'POST', body: new FormData() })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showNotification(`Cleaned up ${data.deleted_count} old recordings`, 'success');
                        loadRecordingStats();
                        loadAlertEvents(); // Refresh events list
                    }
                });
        }
    }

    function updateReviewStatus(eventId, status) {
        const formData = new FormData();
        formData.append('event_id', eventId);
        formData.append('status', status);

        fetch('/api/update_review_status', {
            method: 'POST',
            body: formData
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showNotification('Review status updated', 'success');
                    loadAlertEvents();
                }
            });
    }

    function getStatusClass(status) {
        switch (status) {
            case 'answered': return 'bg-green-100 text-green-800';
            case 'failed': return 'bg-red-100 text-red-800';
            default: return 'bg-yellow-100 text-yellow-800';
        }
    }

    function getReviewClass(status) {
        switch (status) {
            case 'confirmed': return 'bg-green-100 text-green-800';
            case 'false_alarm': return 'bg-yellow-100 text-yellow-800';
            default: return 'bg-gray-100 text-gray-800';
        }
    }

    function showNotification(message, type) {
        // Simple notification implementation
        alert(`${type.toUpperCase()}: ${message}`);
    }

    document.addEventListener('DOMContentLoaded', function () {
        // Initialize
        loadTwilioSettings();
        loadAlertEvents();
        loadRecordingStats();

        // Event listeners
        document.getElementById('twilioSettingsForm').addEventListener('submit', saveTwilioSettings);
        document.getElementById('testCall').addEventListener('click', testTwilioCall);
        document.getElementById('refreshEvents').addEventListener('click', loadAlertEvents);
        document.getElementById('cleanupRecordings').addEventListener('click', cleanupRecordings);

        // Auto-refresh events every 30 seconds
        setInterval(loadAlertEvents, 30000);
        setInterval(loadRecordingStats, 10000);
    });

    function loadTwilioSettings() {
        fetch('/api/twilio_settings')
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const settings = data.settings;
                    document.getElementById('accountSid').value = settings.account_sid || '';
                    document.getElementById('authToken').value = settings.auth_token || '';
                    document.getElementById('twilioNumber').value = settings.twilio_number || '';
                    document.getElementById('primaryNumber').value = settings.primary_number || '';
                    document.getElementById('backupNumber').value = settings.backup_number || '';
                    document.getElementById('testMode').checked = settings.test_mode;
                }
            });
    }

    function saveTwilioSettings(event) {
        event.preventDefault();

        const formData = new FormData(event.target);
        formData.append('test_mode', document.getElementById('testMode').checked);

        fetch('/api/twilio_settings', {
            method: 'POST',
            body: formData
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showNotification('Twilio settings saved successfully!', 'success');
                } else {
                    showNotification('Error saving settings: ' + data.message, 'error');
                }
            });
    }

    function testTwilioCall() {
        const primaryNumber = document.getElementById('primaryNumber').value;
        if (!primaryNumber) {
            alert('Please enter a primary number first');
            return;
        }

        const testNumber = prompt('Enter test phone number:', primaryNumber);
        if (!testNumber) return;

        const formData = new FormData();
        formData.append('test_number', testNumber);

        fetch('/api/test_twilio_call', {
            method: 'POST',
            body: formData
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showNotification('Test call initiated successfully!', 'success');
                } else {
                    showNotification('Test call failed: ' + (data.result?.error || 'Unknown error'), 'error');
                }
            });
    }

    function displayEvents(events) {
        const container = document.getElementById('eventsList');

        if (!events || events.length === 0) {
            container.innerHTML = `
            <div class="py-6 text-center">
                <p class="text-gray-500 text-sm">No alert events found</p>
            </div>
        `;
            return;
        }

        // Step 1: Remove duplicate entries - keep only 1-2 of the same alert type
        const deduplicatedEvents = deduplicateEvents(events);

        let html = '';
        deduplicatedEvents.forEach(event => {
            const timestamp = new Date(event.timestamp).toLocaleString();
            const callStatus = event.call_status || 'pending';
            const reviewStatus = event.review_status || 'pending';
            const isNonAlertEvent =
                event.trigger_type === 'authorized_face' ||
                event.trigger_type === 'known_face';

            html += `
        <div class="bg-white shadow-sm border border-gray-200 rounded-xl p-4 mb-4 hover:shadow-md transition">
            
            <!-- Header -->
            <div class="flex justify-between items-start mb-3">
                <div>
                    <h4 class="font-semibold text-gray-800 capitalize tracking-wide">
                        ${event.trigger_type.replace(/_/g, ' ')}
                        ${event.person_name ? `- ${event.person_name}` : ''}
                    </h4>
                    <p class="text-sm text-gray-500">${timestamp}</p>
                    <p class="text-xs text-gray-400">Event ID: ${event.event_id}</p>
                </div>

                <div class="flex flex-col gap-1 text-right">
                    <span class="px-2 py-1 rounded-md text-xs font-medium ${getStatusClass(callStatus)}">
                        Call: ${callStatus}
                    </span>
                    <span class="px-2 py-1 rounded-md text-xs font-medium ${getReviewClass(reviewStatus)}">
                        Review: ${reviewStatus}
                    </span>
                </div>
            </div>

            <!-- Call Attempts -->
            ${event.call_attempts && event.call_attempts.length > 0
                    ? `
                <div class="mt-3 bg-gray-50 p-3 rounded-lg">
                    <h5 class="text-sm font-semibold mb-2 text-gray-700">Call Attempts:</h5>
                    <div class="space-y-1">
                    ${event.call_attempts
                        .map(
                            attempt => `
                        <div class="text-xs text-gray-600">
                            <span class="font-medium">Attempt ${attempt.attempt_number}</span> â€” 
                            ${attempt.phone_number} â€”
                            <span class="${attempt.status === 'answered'
                                    ? 'text-green-600 font-semibold'
                                    : 'text-red-600 font-semibold'
                                }">${attempt.status}</span>
                            <span class="text-gray-400">at ${new Date(
                                    attempt.timestamp
                                ).toLocaleTimeString()}</span>
                        </div>
                    `
                        )
                        .join('')}
                    </div>
                </div>
            `
                    : ''
                }

            <!-- Video Status -->
            ${event.recording_filepath ? `
                <div class="mt-2 flex items-center text-green-600 text-sm">
                    <i class="fas fa-video mr-2"></i>
                    Video recording available
                </div>
            ` : `
                <div class="mt-2 flex items-center text-gray-500 text-sm">
                    <i class="fas fa-video-slash mr-2"></i>
                    No video recording
                </div>
            `}

            <!-- Actions -->
            <div class="mt-4 flex flex-wrap gap-2">
                ${!isNonAlertEvent
                    ? `
                    <button onclick="handleFalseAlarm('${event.event_id}')"
                        class="bg-yellow-500 hover:bg-yellow-600 text-white px-3 py-1.5 rounded-lg text-xs flex items-center gap-1 font-medium">
                        <i class="fas fa-user-plus"></i> Mark as False Alarm
                    </button>

                    <button onclick="updateReviewStatus('${event.event_id}', 'confirmed')"
                        class="bg-green-500 hover:bg-green-600 text-white px-3 py-1.5 rounded-lg text-xs flex items-center gap-1 font-medium">
                        <i class="fas fa-check"></i> Confirm
                    </button>
                `
                    : ''
                }

                ${event.recording_filepath
                    ? `
                    <button onclick="showVideoModal('${event.recording_filepath}')"
                        class="bg-blue-500 hover:bg-blue-600 text-white px-3 py-1.5 rounded-lg text-xs flex items-center gap-1 font-medium">
                        <i class="fas fa-play mr-1"></i> Play Video
                    </button>
                    <button onclick="verifyRecording('${event.recording_filepath}')" 
                            class="bg-gray-500 hover:bg-gray-600 text-white px-3 py-1.5 rounded-lg text-xs flex items-center gap-1 font-medium">
                        <i class="fas fa-check-circle mr-1"></i>Verify
                    </button>
                `
                    : ''
                }
            </div>

        </div>
        `;
        });

        container.innerHTML = html;
    }

    async function processEventsSequentially(events, index, validEvents, container) {
        if (index >= events.length) {
            // All events processed, now display them with deduplication
            displayFilteredEvents(validEvents, container);
            return;
        }

        const event = events[index];

        try {
            // Check if event has a recording and if it's playable
            if (event.recording_filepath) {
                const isPlayable = await checkVideoPlayability(event.recording_filepath);
                if (isPlayable) {
                    validEvents.push(event);
                }
            } else {
                // Events without videos are still included
                validEvents.push(event);
            }
        } catch (error) {
            console.warn(`Error checking video for event ${event.event_id}:`, error);
            // Include event even if check fails
            validEvents.push(event);
        }

        // Process next event
        processEventsSequentially(events, index + 1, validEvents, container);
    }

    function displayFilteredEvents(events, container) {
        // Step 2: Remove duplicate entries - keep only 1-2 of the same alert type
        const deduplicatedEvents = deduplicateEvents(events);

        if (deduplicatedEvents.length === 0) {
            container.innerHTML = `
            <div class="py-6 text-center">
                <p class="text-gray-500 text-sm">No alert events with playable videos found</p>
            </div>
        `;
            return;
        }

        let html = '';
        deduplicatedEvents.forEach(event => {
            const timestamp = new Date(event.timestamp).toLocaleString();
            const callStatus = event.call_status || 'pending';
            const reviewStatus = event.review_status || 'pending';
            const isNonAlertEvent =
                event.trigger_type === 'authorized_face' ||
                event.trigger_type === 'known_face';

            html += `
        <div class="bg-white shadow-sm border border-gray-200 rounded-xl p-4 mb-4 hover:shadow-md transition">
            
            <!-- Header -->
            <div class="flex justify-between items-start mb-3">
                <div>
                    <h4 class="font-semibold text-gray-800 capitalize tracking-wide">
                        ${event.trigger_type.replace(/_/g, ' ')}
                        ${event.person_name ? `- ${event.person_name}` : ''}
                    </h4>
                    <p class="text-sm text-gray-500">${timestamp}</p>
                    <p class="text-xs text-gray-400">Event ID: ${event.event_id}</p>
                </div>

                <div class="flex flex-col gap-1 text-right">
                    <span class="px-2 py-1 rounded-md text-xs font-medium ${getStatusClass(callStatus)}">
                        Call: ${callStatus}
                    </span>
                    <span class="px-2 py-1 rounded-md text-xs font-medium ${getReviewClass(reviewStatus)}">
                        Review: ${reviewStatus}
                    </span>
                </div>
            </div>

            <!-- Call Attempts -->
            ${event.call_attempts && event.call_attempts.length > 0
                    ? `
                <div class="mt-3 bg-gray-50 p-3 rounded-lg">
                    <h5 class="text-sm font-semibold mb-2 text-gray-700">Call Attempts:</h5>
                    <div class="space-y-1">
                    ${event.call_attempts
                        .map(
                            attempt => `
                        <div class="text-xs text-gray-600">
                            <span class="font-medium">Attempt ${attempt.attempt_number}</span> â€” 
                            ${attempt.phone_number} â€”
                            <span class="${attempt.status === 'answered'
                                    ? 'text-green-600 font-semibold'
                                    : 'text-red-600 font-semibold'
                                }">${attempt.status}</span>
                            <span class="text-gray-400">at ${new Date(
                                    attempt.timestamp
                                ).toLocaleTimeString()}</span>
                        </div>
                    `
                        )
                        .join('')}
                    </div>
                </div>
            `
                    : ''
                }

            <!-- Video Status Indicator -->
            ${event.recording_filepath ? `
                <div class="mt-2 flex items-center text-green-600 text-sm">
                    <i class="fas fa-check-circle mr-2"></i>
                    Video available and playable
                </div>
            ` : `
                <div class="mt-2 flex items-center text-gray-500 text-sm">
                    <i class="fas fa-video-slash mr-2"></i>
                    No video recording available
                </div>
            `}

            <!-- Actions -->
            <div class="mt-4 flex flex-wrap gap-2">
                ${!isNonAlertEvent
                    ? `
                    <button onclick="handleFalseAlarm('${event.event_id}')"
                        class="bg-yellow-500 hover:bg-yellow-600 text-white px-3 py-1.5 rounded-lg text-xs flex items-center gap-1 font-medium">
                        <i class="fas fa-user-plus"></i> Mark as False Alarm
                    </button>

                    <button onclick="updateReviewStatus('${event.event_id}', 'confirmed')"
                        class="bg-green-500 hover:bg-green-600 text-white px-3 py-1.5 rounded-lg text-xs flex items-center gap-1 font-medium">
                        <i class="fas fa-check"></i> Confirm
                    </button>
                `
                    : ''
                }

                ${event.recording_filepath
                    ? `
                    <button onclick="showVideoModal('${event.recording_filepath}')"
                        class="bg-blue-500 hover:bg-blue-600 text-white px-3 py-1.5 rounded-lg text-xs flex items-center gap-1 font-medium">
                        <i class="fas fa-play"></i> Play Video
                    </button>
                `
                    : ''
                }
            </div>

        </div>
        `;
        });

        container.innerHTML = html;
    }

    function deduplicateEvents(events) {
        const eventGroups = {};
        const maxDuplicates = 2; // Maximum number of duplicate entries to show

        // Group events by type and person
        events.forEach(event => {
            // Create a key based on trigger type and person name
            const key = `${event.trigger_type}_${event.person_name || 'unknown'}`;

            if (!eventGroups[key]) {
                eventGroups[key] = [];
            }

            eventGroups[key].push(event);
        });

        // Sort each group by timestamp (newest first) and take only maxDuplicates
        const result = [];
        Object.values(eventGroups).forEach(group => {
            // Sort by timestamp, newest first
            group.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

            // Take only the most recent entries (up to maxDuplicates)
            const recentEvents = group.slice(0, maxDuplicates);
            result.push(...recentEvents);
        });

        // Sort final result by timestamp (newest first)
        return result.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
    }

    function handleFalseAlarm(eventId) {
        // Find the detection ID associated with this event
        fetch(`/api/alert_events`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const event = data.events.find(e => e.event_id === eventId);
                    if (event) {
                        // Get the most recent unauthorized detection
                        fetch('/api/unauthorized_detections')
                            .then(response => response.json())
                            .then(detectionData => {
                                if (detectionData.success && detectionData.detections.length > 0) {
                                    // Find detection that matches this event's timeframe
                                    const eventTime = new Date(event.timestamp);
                                    const matchingDetection = detectionData.detections.find(d => {
                                        const detectionTime = new Date(d.timestamp);
                                        const timeDiff = Math.abs(eventTime - detectionTime);
                                        return timeDiff < 60000; // Within 1 minute
                                    });

                                    if (matchingDetection) {
                                        showFalseAlarmConfirmation(eventId, matchingDetection.id);
                                    } else {
                                        alert('Could not find associated detection for this event');
                                    }
                                } else {
                                    alert('No detections available');
                                }
                            });
                    }
                }
            });
    }

    function showFalseAlarmConfirmation(eventId, detectionId) {
        if (confirm('Do you want to register this face as a Known Person (non-threatening)?')) {
            showFalseAlarmRegistration(eventId, detectionId);
        }
    }

    function showFalseAlarmRegistration(eventId, detectionId) {
        console.log(`ðŸ“¸ Fetching screenshots for detection ID: ${detectionId}`);

        // Fetch screenshots for this detection
        fetch(`/api/get_detection_screenshots/${detectionId}`)
            .then(response => response.json())
            .then(data => {
                console.log('ðŸ“¸ Screenshot data received:', data);

                if (data.success && data.screenshots && data.screenshots.length > 0) {
                    showScreenshotSelectionModal(eventId, detectionId, data.screenshots);
                } else {
                    alert('No screenshots available for this detection');
                }
            })
            .catch(error => {
                console.error('Error fetching screenshots:', error);
                alert('Error loading screenshots: ' + error.message);
            });
    }

    function showScreenshotSelectionModal(eventId, detectionId, screenshots) {
        const modalHtml = `
            <div id="falseAlarmModal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50">
                <div class="bg-white rounded-lg p-6 max-w-4xl w-full mx-4 max-h-[90vh] overflow-y-auto">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-xl font-bold">
                            <i class="fas fa-user-check mr-2 text-green-600"></i>
                            Register as Known Person
                        </h3>
                        <button onclick="closeFalseAlarmModal()" class="text-gray-500 hover:text-gray-700">
                            <i class="fas fa-times text-2xl"></i>
                        </button>
                    </div>
                    
                    <div class="bg-blue-50 p-4 rounded-lg mb-4">
                        <p class="text-sm text-blue-800">
                            <i class="fas fa-info-circle mr-2"></i>
                            <strong>Known Persons</strong> are recognized but won't trigger security alerts.
                            They are different from <strong>Authorized Persons</strong> who have full access.
                        </p>
                    </div>
                    
                    <p class="text-gray-700 mb-4 font-semibold">Select the image(s) to use for registration:</p>
                    
                    <div class="grid grid-cols-2 md:grid-cols-3 gap-4 mb-6" id="screenshotGrid">
                        ${screenshots.map((path, index) => `
                            <div class="relative group">
                                <label class="cursor-pointer block">
                                    <input type="checkbox" 
                                           id="img_${index}" 
                                           value="${path}" 
                                           class="screenshot-checkbox absolute top-3 left-3 w-6 h-6 cursor-pointer z-10"
                                           checked>
                                    <img src="/${path}" 
                                         alt="Detection ${index + 1}" 
                                         class="w-full h-48 object-cover rounded-lg border-4 border-gray-300 group-hover:border-blue-500 transition-all">
                                    <div class="absolute bottom-2 right-2 bg-black bg-opacity-60 text-white px-2 py-1 rounded text-xs">
                                        Image ${index + 1}
                                    </div>
                                </label>
                            </div>
                        `).join('')}
                    </div>
                    
                    <div class="mb-6">
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            <i class="fas fa-user mr-2"></i>Person Name:
                        </label>
                        <input type="text" 
                               id="knownPersonName" 
                               class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                               placeholder="Enter the person's name">
                    </div>
                    
                    <div class="flex space-x-4">
                        <button onclick="submitKnownPersonRegistration(${detectionId})" 
                                class="flex-1 bg-green-600 hover:bg-green-700 text-white font-semibold px-6 py-3 rounded-lg transition-colors">
                            <i class="fas fa-save mr-2"></i>Register as Known Person
                        </button>
                        <button onclick="closeFalseAlarmModal()" 
                                class="bg-gray-600 hover:bg-gray-700 text-white font-semibold px-6 py-3 rounded-lg transition-colors">
                            <i class="fas fa-times mr-2"></i>Cancel
                        </button>
                    </div>
                </div>
            </div>
        `;

        document.body.insertAdjacentHTML('beforeend', modalHtml);
    }

    function submitKnownPersonRegistration(detectionId) {
        const name = document.getElementById('knownPersonName').value.trim();
        if (!name) {
            alert('Please enter a name');
            return;

        }

        const selectedImages = Array.from(document.querySelectorAll('.screenshot-checkbox:checked'))
            .map(cb => cb.value);

        if (selectedImages.length === 0) {
            alert('Please select at least one image');
            return;
        }

        console.log(`ðŸ“ Submitting Known Person registration:`, {
            name: name,
            detection_id: detectionId,
            images: selectedImages
        });

        const formData = new FormData();
        formData.append('name', name);
        formData.append('detection_id', detectionId);
        selectedImages.forEach(img => formData.append('selected_images[]', img));

        // Show loading state
        const submitButton = event.target;
        const originalHTML = submitButton.innerHTML;
        submitButton.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Registering...';
        submitButton.disabled = true;

        fetch('/api/register_known_person', {
            method: 'POST',
            body: formData
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert(`âœ… ${data.message}\n\nThis person will now be recognized as a Known Person and won't trigger security alerts.`);
                    closeFalseAlarmModal();
                    loadAlertEvents(); // Refresh the alerts list
                } else {
                    alert('âŒ Error: ' + data.error);
                    submitButton.innerHTML = originalHTML;
                    submitButton.disabled = false;
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('âŒ An error occurred while registering the person');
                submitButton.innerHTML = originalHTML;
                submitButton.disabled = false;
            });
    }

    function closeFalseAlarmModal() {
        const modal = document.getElementById('falseAlarmModal');
        if (modal) {
            modal.remove();
        }
    }

    function showVideoModal(recordingPath) {
        const modalHtml = `
        <div id="videoModal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50">
            <div class="bg-white rounded-lg p-4 max-w-4xl w-full mx-4">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-bold">Security Recording</h3>
                    <button onclick="closeVideoModal()" class="text-gray-500 hover:text-gray-700">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <video controls width="100%" class="max-w-full rounded-lg" autoplay>
                    <source src="/${recordingPath}" type="video/mp4">
                    Your browser does not support the video tag.
                </video>
                <div class="mt-4 flex justify-between items-center">
                    <button onclick="verifyRecording('${recordingPath}')" 
                            class="bg-gray-600 hover:bg-gray-700 text-white px-3 py-1 rounded text-sm">
                        <i class="fas fa-check-circle mr-1"></i>Verify Playback
                    </button>
                    <button onclick="downloadRecording('${recordingPath}')" 
                            class="bg-green-600 hover:bg-green-700 text-white px-3 py-1 rounded text-sm">
                        <i class="fas fa-download mr-1"></i>Download
                    </button>
                </div>
            </div>
        </div>
        `;

        const modal = document.createElement('div');
        modal.id = 'videoModal';
        modal.innerHTML = modalHtml;
        document.body.appendChild(modal);
    }

    function closeVideoModal() {
        const modal = document.getElementById('videoModal');
        if (modal) {
            modal.remove();
        }
    }

    function verifyRecording(recordingPath) {
        const filename = recordingPath.split('/').pop();

        fetch(`/api/verify_recording/${filename}`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const verification = data.verification;
                    if (verification.playable) {
                        showNotification(`âœ… Video is playable: ${verification.duration_seconds}s, ${verification.file_size_mb}MB`, 'success');
                    } else {
                        showNotification(`âŒ Video playback issue: ${verification.error}`, 'error');
                    }
                } else {
                    showNotification('âŒ Verification failed: ' + data.error, 'error');
                }
            })
            .catch(error => {
                showNotification('âŒ Network error during verification', 'error');
            });
    }

    function downloadRecording(recordingPath) {
        const link = document.createElement('a');
        link.href = `/${recordingPath}`;
        link.download = recordingPath.split('/').pop();
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }

    // Close modal when clicking outside
    document.addEventListener('click', function (event) {
        const videoModal = document.getElementById('videoModal');
        if (videoModal && event.target === videoModal) {
            closeVideoModal();
        }

        const falseAlarmModal = document.getElementById('falseAlarmModal');
        if (falseAlarmModal && event.target === falseAlarmModal) {
            closeFalseAlarmModal();
        }
    });

    function loadRecordingStats() {
        fetch('/api/recording_stats')
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const stats = data.stats;
                    document.getElementById('recordingStatus').textContent =
                        stats.is_recording ? 'Active' : 'Inactive';
                    document.getElementById('recordingStatus').className =
                        stats.is_recording ? 'text-2xl font-bold text-green-600' : 'text-2xl font-bold text-gray-600';

                    document.getElementById('storageStatus').textContent =
                        `${stats.total_recordings} recordings, ${stats.total_size_gb} GB`;
                }
            });
    }

    function cleanupRecordings() {
        if (confirm('Delete recordings older than 3 days?')) {
            fetch('/api/cleanup_recordings', { method: 'POST', body: new FormData() })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showNotification(`Cleaned up ${data.deleted_count} old recordings`, 'success');
                        loadRecordingStats();
                        loadAlertEvents();
                    }
                });
        }
    }

    function updateReviewStatus(eventId, status) {
        const formData = new FormData();
        formData.append('event_id', eventId);
        formData.append('status', status);

        fetch('/api/update_review_status', {
            method: 'POST',
            body: formData
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showNotification('Review status updated', 'success');
                    loadAlertEvents();
                }
            });
    }

    function getStatusClass(status) {
        switch (status) {
            case 'answered': return 'bg-green-100 text-green-800';
            case 'failed': return 'bg-red-100 text-red-800';
            default: return 'bg-yellow-100 text-yellow-800';
        }
    }

    function getReviewClass(status) {
        switch (status) {
            case 'confirmed': return 'bg-green-100 text-green-800';
            case 'false_alarm': return 'bg-yellow-100 text-yellow-800';
            default: return 'bg-gray-100 text-gray-800';
        }
    }

    function showNotification(message, type) {
        // Create a better notification system
        const notification = document.createElement('div');
        notification.className = `fixed top-4 right-4 z-50 px-6 py-3 rounded-lg shadow-lg ${type === 'success' ? 'bg-green-600' : 'bg-red-600'
            } text-white`;
        notification.innerHTML = `
            <div class="flex items-center space-x-2">
                <i class="fas ${type === 'success' ? 'fa-check-circle' : 'fa-exclamation-circle'}"></i>
                <span>${message}</span>
            </div>
        `;
        document.body.appendChild(notification);

        setTimeout(() => {
            notification.remove();
        }, 3000);
    }

    // Add filtering functionality
    function setupFiltering() {
        const filterButtons = document.querySelectorAll('.filter-btn');
        filterButtons.forEach(btn => {
            btn.addEventListener('click', function () {
                const filterType = this.getAttribute('data-filter');
                loadFilteredAlerts(filterType);

                // Update active button
                filterButtons.forEach(b => b.classList.remove('active'));
                this.classList.add('active');
            });
        });
    }

    function loadFilteredAlerts(filterType = 'all') {
        fetch(`/api/get_filtered_alerts?filter=${filterType}`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    displayAlertsWithVideos(data.alerts);
                }
            });
    }

    function displayAlertsWithVideos(alerts, filterType) {
        const container = document.getElementById('alertsContainer');

        if (!alerts || alerts.length === 0) {
            container.innerHTML = `
            <div class="text-center py-8">
                <i class="fas fa-inbox text-4xl text-gray-400 mb-4"></i>
                <p class="text-gray-500 text-lg">No alerts found</p>
                <p class="text-sm text-gray-400 mt-2">No ${filterType} alerts in the system</p>
            </div>
        `;
            return;
        }

        let html = '';
        alerts.forEach(alert => {
            const timestamp = new Date(alert.timestamp).toLocaleString();
            const category = alert.category || 'other';
            const confidencePercent = Math.round((alert.confidence || 0) * 100);

            // Fix the recording path - ensure it's properly formatted
            let recordingPath = alert.recording_path;
            let cleanRecordingPath = '';

            if (recordingPath) {
                // Clean the path for web access
                cleanRecordingPath = recordingPath.replace(/^\/+/, '');
                if (!cleanRecordingPath.startsWith('static/recordings/')) {
                    // Extract filename and rebuild path
                    const filename = recordingPath.split('/').pop() || recordingPath.split('\\').pop();
                    cleanRecordingPath = `static/recordings/${filename}`;
                }
                // Ensure it starts with a slash for absolute path
                cleanRecordingPath = '/' + cleanRecordingPath;
            }

            // Determine icon and color based on category
            let icon, color, badge;
            switch (category) {
                case 'authorized':
                    icon = 'fa-user-check';
                    color = 'green';
                    badge = 'Authorized';
                    break;
                case 'known':
                    icon = 'fa-user-friends';
                    color = 'blue';
                    badge = 'Known Person';
                    break;
                case 'unauthorized':
                    icon = 'fa-user-times';
                    color = 'red';
                    badge = 'Unauthorized';
                    break;
                case 'motion':
                    icon = 'fa-running';
                    color = 'orange';
                    badge = 'Motion';
                    break;
                default:
                    icon = 'fa-bell';
                    color = 'gray';
                    badge = 'Alert';
            }

            html += `
        <div class="alert-item bg-white rounded-lg shadow-md p-4 mb-4 border-l-4 ${category === 'unauthorized' ? 'border-red-500' :
                    category === 'authorized' ? 'border-green-500' :
                        category === 'known' ? 'border-blue-500' : 'border-orange-500'
                }">
            <div class="flex justify-between items-start">
                <div class="flex-1">
                    <div class="flex items-center space-x-3 mb-2">
                        <i class="fas ${icon} text-${color}-600 text-xl"></i>
                        <div>
                            <h3 class="font-semibold text-lg ${category === 'unauthorized' ? 'text-red-700' :
                    category === 'authorized' ? 'text-green-700' :
                        category === 'known' ? 'text-blue-700' : 'text-orange-700'
                }">
                                ${alert.person_name || 'Unknown'}
                            </h3>
                            <div class="flex items-center space-x-2 mt-1">
                                <span class="px-2 py-1 rounded text-xs bg-${color}-100 text-${color}-800">${badge}</span>
                                <span class="px-2 py-1 rounded text-xs bg-gray-100 text-gray-700">${confidencePercent}% confidence</span>
                            </div>
                        </div>
                    </div>
                    <p class="text-gray-600 capitalize">${alert.type ? alert.type.replace('_', ' ') : 'Detection'}</p>
                    <p class="text-sm text-gray-500">${timestamp}</p>
                    <p class="text-xs text-gray-400">Category: ${category}</p>
                    ${cleanRecordingPath ? `<p class="text-xs text-blue-400 break-all mt-1">Recording: ${cleanRecordingPath.split('/').pop()}</p>` : ''}
                </div>
                
                <div class="flex space-x-2">
                    ${alert.screenshot_path ? `
                    <button onclick="showImageModal('${alert.screenshot_path}')" 
                            class="bg-gray-600 hover:bg-gray-700 text-white px-3 py-1 rounded text-sm">
                        <i class="fas fa-image mr-1"></i>View Image
                    </button>
                    ` : ''}
                    
                    ${cleanRecordingPath ? `
                    <button onclick="playRecording('${cleanRecordingPath}')" 
                            class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded text-sm">
                        <i class="fas fa-play mr-1"></i>Play Video
                    </button>
                    ` : ''}
                </div>
            </div>
            
            ${cleanRecordingPath ? `
            <div class="mt-3">
                <div class="bg-gray-100 p-3 rounded-lg">
                    <p class="text-xs text-gray-600 mb-1">Recording Preview:</p>
                    <video controls width="100%" class="max-w-full rounded" preload="metadata">
                        <source src="${cleanRecordingPath}" type="video/mp4">
                        Your browser does not support the video tag.
                    </video>
                    <div class="flex justify-between items-center mt-2">
                        <button onclick="verifyRecording('${cleanRecordingPath}')" 
                                class="text-xs text-gray-600 hover:text-blue-600">
                            <i class="fas fa-check-circle mr-1"></i>Verify Playback
                        </button>
                        <button onclick="downloadRecording('${cleanRecordingPath}')" 
                                class="text-xs text-green-600 hover:text-green-800">
                            <i class="fas fa-download mr-1"></i>Download
                        </button>
                    </div>
                </div>
            </div>
            ` : ''}
        </div>
        `;
        });

        container.innerHTML = html;
    }

    // Initialize when page loads
    document.addEventListener('DOMContentLoaded', function () {
        console.log('ðŸš€ Initializing alert filters...');

        // Initialize Twilio settings
        loadTwilioSettings();
        loadRecordingStats();

        // Event listeners
        document.getElementById('twilioSettingsForm').addEventListener('submit', saveTwilioSettings);
        document.getElementById('testCall').addEventListener('click', testTwilioCall);

        // Fixed refresh button
        document.getElementById('refreshEvents').addEventListener('click', function () {
            const activeFilter = document.querySelector('.filter-btn.active');
            if (activeFilter) {
                const filterType = activeFilter.getAttribute('data-filter');
                console.log(`ðŸ”„ Refreshing with filter: ${filterType}`);
                loadEventsByFilter(filterType);
            } else {
                // Default to unauthorized
                loadEventsByFilter('unauthorized');
            }
        });

        document.getElementById('cleanupRecordings').addEventListener('click', cleanupRecordings);

        // Setup filters - this initializes the filter buttons
        setupAlertFilters();

        // Load initial data - start with unauthorized
        loadEventsByFilter('unauthorized');

        // Auto-refresh based on active filter
        setInterval(function () {
            const activeFilter = document.querySelector('.filter-btn.active');
            if (activeFilter) {
                const filterType = activeFilter.getAttribute('data-filter');
                loadEventsByFilter(filterType);
            }
        }, 30000);

        console.log('âœ… Alert filters initialized');
    });

    function playRecording(recordingPath) {
        console.log('Playing recording from path:', recordingPath);

        // Create modal for video playback
        const modalHtml = `
    <div id="videoModal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50">
        <div class="bg-white rounded-lg p-4 max-w-4xl w-full mx-4">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-bold">Security Recording</h3>
                <button onclick="closeVideoModal()" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="bg-black rounded-lg overflow-hidden">
                <video id="modalVideo" controls autoplay width="100%" height="auto" class="w-full max-h-96">
                    <source src="${recordingPath}" type="video/mp4">
                    Your browser does not support the video tag.
                </video>
            </div>
            <div class="mt-4 flex justify-between items-center">
                <button onclick="verifyRecording('${recordingPath}')" 
                        class="bg-gray-600 hover:bg-gray-700 text-white px-3 py-2 rounded text-sm">
                    <i class="fas fa-check-circle mr-1"></i>Verify Playback
                </button>
                <button onclick="downloadRecording('${recordingPath}')" 
                        class="bg-green-600 hover:bg-green-700 text-white px-3 py-2 rounded text-sm">
                    <i class="fas fa-download mr-1"></i>Download
                </button>
                <button onclick="closeVideoModal()" 
                        class="bg-red-600 hover:bg-red-700 text-white px-3 py-2 rounded text-sm">
                    Close
                </button>
            </div>
            <div class="mt-2 text-xs text-gray-500 break-all">
                File: ${recordingPath}
            </div>
        </div>
    </div>
    `;

        const modal = document.createElement('div');
        modal.id = 'videoModal';
        modal.innerHTML = modalHtml;
        document.body.appendChild(modal);

        // Add event listener to handle video errors
        const video = document.getElementById('modalVideo');
        video.addEventListener('error', function (e) {
            console.error('Video error:', e);
            console.error('Video error details:', video.error);
            showNotification('âŒ Error loading video. Please check the file path.', 'error');
        });

        video.addEventListener('loadeddata', function () {
            console.log('Video loaded successfully, duration:', video.duration);
        });

        video.addEventListener('canplay', function () {
            console.log('Video can play now');
            video.play().catch(e => {
                console.error('Auto-play failed:', e);
            });
        });
    }

    function closeVideoModal() {
        const modal = document.getElementById('videoModal');
        if (modal) {
            modal.remove();
        }
    }

    function downloadRecording(recordingPath) {
        const link = document.createElement('a');
        link.href = `/${recordingPath}`;
        link.download = recordingPath.split('/').pop();
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }

    // Initialize when page loads
    document.addEventListener('DOMContentLoaded', function () {
        setupFiltering();
        loadFilteredAlerts('all');
    });

    // COMPLETELY SEPARATE FUNCTIONS FOR AUTHORIZED AND KNOWN EVENTS
    // These don't touch or modify any unauthorized functionality

    function loadAuthorizedEvents() {
        console.log('Loading authorized events...');

        fetch('/api/get_authorized_events')
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    displayAuthorizedEvents(data.events);
                } else {
                    console.error('Failed to load authorized events:', data.error);
                    showNotification('Error loading authorized events', 'error');
                }
            })
            .catch(error => {
                console.error('Error loading authorized events:', error);
                showNotification('Network error loading authorized events', 'error');
            });
    }

    function loadKnownEvents() {
        console.log('Loading known events...');

        fetch('/api/get_known_events')
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    displayKnownEvents(data.events);
                } else {
                    console.error('Failed to load known events:', data.error);
                    showNotification('Error loading known events', 'error');
                }
            })
            .catch(error => {
                console.error('Error loading known events:', error);
                showNotification('Network error loading known events', 'error');
            });
    }


    // 3. Display function for AUTHORIZED events
    function displayAuthorizedEvents(events) {
        const container = document.getElementById('eventsList');

        if (!events || events.length === 0) {
            container.innerHTML = `
            <div class="text-center py-8">
                <i class="fas fa-user-check text-4xl text-green-400 mb-4"></i>
                <p class="text-gray-500 text-lg">No authorized events found</p>
                <p class="text-sm text-gray-400 mt-2">Authorized person detections will appear here</p>
            </div>
        `;
            return;
        }

        let html = '<div class="mb-4 p-3 bg-green-50 border border-green-200 rounded-lg"><h3 class="font-semibold text-green-800"><i class="fas fa-user-check mr-2"></i>Authorized Persons</h3></div>';

        events.forEach(event => {
            const timestamp = new Date(event.timestamp).toLocaleString();
            const confidencePercent = Math.round((event.confidence || 0) * 100);
            let cleanRecordingPath = '';

            if (event.recording_path) {
                cleanRecordingPath = event.recording_path.replace(/^\/+/, '');
                if (!cleanRecordingPath.startsWith('static/recordings/')) {
                    const filename = event.recording_path.split('/').pop() || event.recording_path.split('\\').pop();
                    cleanRecordingPath = `static/recordings/${filename}`;
                }
                cleanRecordingPath = '/' + cleanRecordingPath;
            }

            html += `
        <div class="border border-green-200 rounded-lg p-4 mb-4 bg-green-50 shadow-sm">
            <div class="flex justify-between items-start mb-3">
                <div class="flex items-center space-x-3">
                    <i class="fas fa-user-check text-green-600 text-xl"></i>
                    <div>
                        <h4 class="font-semibold text-lg text-green-800">${event.person_name || 'Authorized Person'}</h4>
                        <div class="flex items-center space-x-2 mt-1">
                            <span class="px-2 py-1 rounded text-xs bg-green-100 text-green-800">Authorized</span>
                            <span class="px-2 py-1 rounded text-xs bg-gray-100 text-gray-700">${confidencePercent}% confidence</span>
                        </div>
                    </div>
                </div>
                <div class="text-right">
                    <p class="text-sm text-gray-600">${timestamp}</p>
                    <p class="text-xs text-gray-500">ID: ${event.id}</p>
                </div>
            </div>
            
            <div class="flex flex-wrap gap-2 mt-3">
                ${event.screenshot_path ? `
                <button onclick="showImageModal('${event.screenshot_path}')" 
                        class="bg-gray-600 hover:bg-gray-700 text-white px-3 py-2 rounded text-sm flex items-center">
                    <i class="fas fa-image mr-2"></i>View Image
                </button>
                ` : ''}
                
                ${cleanRecordingPath ? `
                <button onclick="playRecording('${cleanRecordingPath}')" 
                        class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-2 rounded text-sm flex items-center">
                    <i class="fas fa-play mr-2"></i>Play Video
                </button>
                ` : ''}
            </div>
        </div>
        `;
        });

        container.innerHTML = html;
    }

    function displayKnownEvents(events) {
        const container = document.getElementById('eventsList');

        if (!events || events.length === 0) {
            container.innerHTML = `
            <div class="text-center py-8">
                <i class="fas fa-user-friends text-4xl text-blue-400 mb-4"></i>
                <p class="text-gray-500 text-lg">No known person events found</p>
                <p class="text-sm text-gray-400 mt-2">Known person detections will appear here</p>
            </div>
        `;
            return;
        }

        let html = '<div class="mb-4 p-3 bg-blue-50 border border-blue-200 rounded-lg"><h3 class="font-semibold text-blue-800"><i class="fas fa-user-friends mr-2"></i>Known Persons</h3></div>';

        events.forEach(event => {
            const timestamp = new Date(event.timestamp).toLocaleString();
            const confidencePercent = Math.round((event.confidence || 0) * 100);
            let cleanRecordingPath = '';

            if (event.recording_path) {
                cleanRecordingPath = event.recording_path.replace(/^\/+/, '');
                if (!cleanRecordingPath.startsWith('static/recordings/')) {
                    const filename = event.recording_path.split('/').pop() || event.recording_path.split('\\').pop();
                    cleanRecordingPath = `static/recordings/${filename}`;
                }
                cleanRecordingPath = '/' + cleanRecordingPath;
            }

            html += `
        <div class="border border-blue-200 rounded-lg p-4 mb-4 bg-blue-50 shadow-sm">
            <div class="flex justify-between items-start mb-3">
                <div class="flex items-center space-x-3">
                    <i class="fas fa-user-friends text-blue-600 text-xl"></i>
                    <div>
                        <h4 class="font-semibold text-lg text-blue-800">${event.person_name || 'Known Person'}</h4>
                        <div class="flex items-center space-x-2 mt-1">
                            <span class="px-2 py-1 rounded text-xs bg-blue-100 text-blue-800">Known Person</span>
                            <span class="px-2 py-1 rounded text-xs bg-gray-100 text-gray-700">${confidencePercent}% confidence</span>
                        </div>
                    </div>
                </div>
                <div class="text-right">
                    <p class="text-sm text-gray-600">${timestamp}</p>
                    <p class="text-xs text-gray-500">ID: ${event.id}</p>
                </div>
            </div>
            
            <div class="flex flex-wrap gap-2 mt-3">
                ${event.screenshot_path ? `
                <button onclick="showImageModal('${event.screenshot_path}')" 
                        class="bg-gray-600 hover:bg-gray-700 text-white px-3 py-2 rounded text-sm flex items-center">
                    <i class="fas fa-image mr-2"></i>View Image
                </button>
                ` : ''}
                
                ${cleanRecordingPath ? `
                <button onclick="playRecording('${cleanRecordingPath}')" 
                        class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-2 rounded text-sm flex items-center">
                    <i class="fas fa-play mr-2"></i>Play Video
                </button>
                ` : ''}
            </div>
        </div>
        `;
        });

        container.innerHTML = html;
    }

    // Enhanced filter setup - connects to the new separate functions
    function setupAlertFilters() {
        const filterButtons = document.querySelectorAll('.filter-btn');

        filterButtons.forEach(btn => {
            btn.addEventListener('click', function () {
                const filterType = this.getAttribute('data-filter');

                console.log(`ðŸ”˜ Filter clicked: ${filterType}`);

                // Remove active class from all buttons
                filterButtons.forEach(b => b.classList.remove('active'));
                // Add active class to clicked button
                this.classList.add('active');

                // Load events based on filter type
                loadEventsByFilter(filterType);
            });
        });
    }

    function loadEventsByFilter(filterType) {
        console.log(`ðŸ“Š Loading events with filter: ${filterType}`);

        const container = document.getElementById('eventsList');
        container.innerHTML = '<div class="text-center py-8"><i class="fas fa-spinner fa-spin text-2xl text-blue-600"></i><p class="mt-2 text-gray-600">Loading events...</p></div>';

        // Map filter types to API endpoints
        let apiEndpoint = '/api/alert_events'; // Default unauthorized

        switch (filterType) {
            case 'authorized':
                apiEndpoint = '/api/get_authorized_events';
                break;
            case 'known':
                apiEndpoint = '/api/get_known_events';
                break;
            case 'unauthorized':
            case 'all':
            default:
                apiEndpoint = '/api/alert_events'; // Unauthorized events
        }

        fetch(apiEndpoint)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Use appropriate display function based on filter
                    if (filterType === 'authorized') {
                        displayAuthorizedEvents(data.events);
                    } else if (filterType === 'known') {
                        displayKnownEvents(data.events);
                    } else {
                        displayEvents(data.events); // Unauthorized
                    }

                    console.log(`âœ… Loaded ${data.events.length} events for filter: ${filterType}`);
                } else {
                    console.error('Failed to load events:', data.error);
                    showNotification('Error loading events: ' + data.error, 'error');
                    container.innerHTML = '<div class="text-center py-8 text-red-600"><i class="fas fa-exclamation-triangle"></i><p>Error loading events</p></div>';
                }
            })
            .catch(error => {
                console.error('Error loading events:', error);
                showNotification('Network error loading events', 'error');
                container.innerHTML = '<div class="text-center py-8 text-red-600"><i class="fas fa-exclamation-triangle"></i><p>Network error</p></div>';
            });
    }

    // Initialize when page loads
    document.addEventListener('DOMContentLoaded', function () {
        setupAlertFilters();
        loadAlertEvents(); // Start with unauthorized (existing behavior)
    });
</script>

</script>
{% endblock %}